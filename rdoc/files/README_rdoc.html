<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01//EN" "http://www.w3.org/TR/html4/strict.dtd">
<html lang='en'>
<head>
<title>README.rdoc</title>
<meta name='viewport' content='width=device-width, initial-scale=1'>
<meta content='text/html; charset=UTF-8' http-equiv='Content-Type'>
<link href='../css/style.css' media='screen' rel='stylesheet' type='text/css'>
<script type='text/javascript'>
  function popupCode(url) {
    window.open(url, "Code", "resizable=yes,scrollbars=yes,toolbar=no,status=no,height=150,width=400")
  }
  
  function toggleCode(id) {
    var code = document.getElementById(id)
  
    code.style.display = code.style.display != 'block' ? 'block' : 'none'
    return true
  }
  
  // Make codeblocks hidden by default
  document.writeln('<' + 'style type="text/css">.method .source pre { display: none }<\/style>')
</script>
</head>
<body class='page'>
<div class='file' id='wrapper'>
<div class='header'>
<h1 class='name'>README.rdoc
</h1>
<div class='paths'>
README.rdoc
</div>
<div class='last-update'>
Last Update:
<span class='datetime'>2025-04-07 07:35:10 -0700</span>
</div>
</div>
<div id='content'>
<div id='text'>
<div id='description'>
<h1 id="label-Rodauth"><a href="../classes/Rodauth.html"><code>Rodauth</code></a><span><a href="#label-Rodauth">&para;</a> <a href="#top">&uarr;</a></span></h1>

<p><a href="../classes/Rodauth.html"><code>Rodauth</code></a> is Ruby’s most advanced authentication framework, designed to work in any rack application.  It’s built using Roda and Sequel, but it can be used with other web frameworks, database libraries, and databases.</p>

<p>When used with PostgreSQL, MySQL, and Microsoft SQL Server in the default configuration, it offers additional security for password hashes by protecting access via database functions.</p>

<p><a href="../classes/Rodauth.html"><code>Rodauth</code></a> supports multiple multifactor authentication methods, multiple passwordless authentication methods, and offers both an HTML and JSON API for all supported features.</p>

<h2 id="label-Design+Goals">Design Goals<span><a href="#label-Design+Goals">&para;</a> <a href="#top">&uarr;</a></span></h2>
<ul><li>
<p>Security: Ship in a maximum security by default configuration</p>
</li><li>
<p>Simplicity: Allow for easy configuration via a DSL</p>
</li><li>
<p>Flexibility: Allow for easy overriding of any part of the framework</p>
</li></ul>

<h2 id="label-Features">Features<span><a href="#label-Features">&para;</a> <a href="#top">&uarr;</a></span></h2>
<ul><li>
<p>Login</p>
</li><li>
<p>Logout</p>
</li><li>
<p>Change Password</p>
</li><li>
<p>Change Login</p>
</li><li>
<p>Reset Password</p>
</li><li>
<p>Create Account</p>
</li><li>
<p>Close Account</p>
</li><li>
<p>Verify Account</p>
</li><li>
<p>Confirm Password</p>
</li><li>
<p>Remember (Autologin via token)</p>
</li><li>
<p>Lockout (Bruteforce protection)</p>
</li><li>
<p>Audit Logging</p>
</li><li>
<p>Email Authentication (Passwordless login via email link)</p>
</li><li>
<p>WebAuthn (Multifactor authentication via WebAuthn)</p>
</li><li>
<p>WebAuthn Login (Passwordless login via WebAuthn)</p>
</li><li>
<p>WebAuthn Verify Account (Passwordless WebAuthn Setup)</p>
</li><li>
<p>WebAuthn Autofill (Autofill WebAuthn credentials on login)</p>
</li><li>
<p>WebAuthn Modify Email (Email when WebAuthn authenticator added or removed)</p>
</li><li>
<p>OTP (Multifactor authentication via TOTP)</p>
</li><li>
<p>OTP Modify Email (Email when TOTP authentication setup or disabled)</p>
</li><li>
<p>OTP Unlock (Unlock TOTP authentication after lockout)</p>
</li><li>
<p>OTP Lockout Email (Email when TOTP authentication locked out or unlocked)</p>
</li><li>
<p>Recovery Codes (Multifactor authentication via backup codes)</p>
</li><li>
<p>SMS Codes (Multifactor authentication via SMS)</p>
</li><li>
<p>Verify Login Change (Verify new login before changing login)</p>
</li><li>
<p>Verify Account Grace Period (Don’t require verification before login)</p>
</li><li>
<p>Password Grace Period (Don’t require password entry if recently entered)</p>
</li><li>
<p>Password Complexity (More sophisticated checks)</p>
</li><li>
<p>Password Pepper</p>
</li><li>
<p>Disallow Password Reuse</p>
</li><li>
<p>Disallow Common Passwords</p>
</li><li>
<p>Password Expiration</p>
</li><li>
<p>Account Expiration</p>
</li><li>
<p>Session Expiration</p>
</li><li>
<p>Active Sessions (Prevent session reuse after logout, allow logout of all sessions)</p>
</li><li>
<p>Single Session (Only one active session per account)</p>
</li><li>
<p>JSON (JSON API support for all other features)</p>
</li><li>
<p>JWT (JSON Web Token support for all other features)</p>
</li><li>
<p>JWT Refresh (Access &amp; Refresh Token)</p>
</li><li>
<p>JWT CORS (Cross-Origin Resource Sharing)</p>
</li><li>
<p>Update Password Hash (when hash cost changes)</p>
</li><li>
<p>Argon2</p>
</li><li>
<p>HTTP Basic Auth</p>
</li><li>
<p>Change Password Notify</p>
</li><li>
<p>Reset Password Notify</p>
</li><li>
<p>Internal Request</p>
</li><li>
<p>Path Class Methods</p>
</li></ul>

<h2 id="label-Resources">Resources<span><a href="#label-Resources">&para;</a> <a href="#top">&uarr;</a></span></h2>
<table class="rdoc-list note-list"><tbody><tr><td class='label'>Website </td><td>
<p><a target="_top" href="http://rodauth.jeremyevans.net">rodauth.jeremyevans.net</a></p>
</td></tr><tr><td class='label'>Demo Site </td><td>
<p><a target="_top" href="http://rodauth-demo.jeremyevans.net">rodauth-demo.jeremyevans.net</a></p>
</td></tr><tr><td class='label'>Source </td><td>
<p><a target="_top" href="http://github.com/jeremyevans/rodauth">github.com/jeremyevans/rodauth</a></p>
</td></tr><tr><td class='label'>Bugs </td><td>
<p><a target="_top" href="http://github.com/jeremyevans/rodauth/issues">github.com/jeremyevans/rodauth/issues</a></p>
</td></tr><tr><td class='label'>Discussion Forum (GitHub Discussions) </td><td>
<p><a target="_top" href="https://github.com/jeremyevans/rodauth/discussions">github.com/jeremyevans/rodauth/discussions</a></p>
</td></tr><tr><td class='label'>Alternate Discussion Forum (Google Groups) </td><td>
<p><a target="_top" href="https://groups.google.com/forum/#!forum/rodauth">groups.google.com/forum/#!forum/rodauth</a></p>
</td></tr></tbody></table>

<h2 id="label-Dependencies">Dependencies<span><a href="#label-Dependencies">&para;</a> <a href="#top">&uarr;</a></span></h2>

<p>There are some dependencies that <a href="../classes/Rodauth.html"><code>Rodauth</code></a> uses depending on the features in use. These are development dependencies instead of runtime dependencies in the gem as it is possible to run without them:</p>
<table class="rdoc-list note-list"><tbody><tr><td class='label'>tilt </td><td>
<p>Used by all features unless in JSON API only mode or using :render=&gt;false plugin option.</p>
</td></tr><tr><td class='label'>rack_csrf </td><td>
<p>Used for CSRF support if the <code>csrf: :rack_csrf</code> plugin option is given (the default is to use Roda’s route_csrf plugin, as that allows for more secure request-specific tokens).</p>
</td></tr><tr><td class='label'>bcrypt </td><td>
<p>Used by default for password hashing, can be skipped if password_match? is overridden for custom authentication.</p>
</td></tr><tr><td class='label'>argon2 </td><td>
<p>Used by the argon2 feature as alternative to bcrypt for password hashing.</p>
</td></tr><tr><td class='label'>mail </td><td>
<p>Used by default for mailing in the <a href="doc/reset_password_rdoc.html">reset_password</a>, <a href="doc/verify_account_rdoc.html">verify_account</a>, <a href="doc/verify_login_change_rdoc.html">verify_login_change</a>, <a href="doc/change_password_notify_rdoc.html">change_password_notify</a>, lockout, and <a href="doc/email_auth_rdoc.html">email_auth</a> features.</p>
</td></tr><tr><td class='label'>rotp </td><td>
<p>Used by the otp feature</p>
</td></tr><tr><td class='label'>rqrcode </td><td>
<p>Used by the otp feature</p>
</td></tr><tr><td class='label'>jwt </td><td>
<p>Used by the jwt feature</p>
</td></tr><tr><td class='label'>webauthn </td><td>
<p>Used by the webauthn feature</p>
</td></tr></tbody></table>

<p>You can use <code>gem install --development rodauth</code> to install the development dependencies in order to run tests.</p>

<h2 id="label-Security">Security<span><a href="#label-Security">&para;</a> <a href="#top">&uarr;</a></span></h2>

<h3 id="label-Password+Hash+Access+Via+Database+Functions">Password Hash Access Via Database Functions<span><a href="#label-Password+Hash+Access+Via+Database+Functions">&para;</a> <a href="#top">&uarr;</a></span></h3>

<p>By default on PostgreSQL, MySQL, and Microsoft SQL Server, <a href="../classes/Rodauth.html"><code>Rodauth</code></a> uses database functions to access password hashes, with the user running the application unable to get direct access to password hashes.  This reduces the risk of an attacker being able to access password hashes and use them to attack other sites.</p>

<p>The rest of this section describes this feature in more detail, but note that <a href="../classes/Rodauth.html"><code>Rodauth</code></a> does not require this feature be used and works correctly without it.  There may be cases where you cannot use this feature, such as when using a different database or when you do not have full control over the database you are using.</p>

<p>Passwords are hashed using bcrypt by default, and the password hashes are kept in a separate table from the accounts table, with a foreign key referencing the accounts table.  Two database functions are added, one to retrieve the salt for a password, and the other to check if a given password hash matches the password hash for the user.</p>

<p>Two database accounts are used. The first is the account that the application uses, which is referred to as the <code>app</code> account. The <code>app</code> account does not have access to read the password hashes. The other account handles password hashes and is referred to as the <code>ph</code> account.  The <code>ph</code> account sets up the database functions that can retrieve the salt for a given account’s password, and check if a password hash matches for a given account.  The <code>ph</code> account sets these functions up so that the <code>app</code> account can execute the functions using the <code>ph</code> account’s permissions.  This allows the <code>app</code> account to check passwords without having access to read password hashes.</p>

<p>While the <code>app</code> account is not be able to read password hashes, it is still be able to insert password hashes, update passwords hashes, and delete password hashes, so the additional security is not that painful.</p>

<p>By disallowing the <code>app</code> account access to the password hashes, it is much more difficult for an attacker to access the password hashes, even if they are able to exploit an SQL injection or remote code execution vulnerability in the application.</p>

<p>The reason for extra security in regards to password hashes stems from the fact that people tend to choose poor passwords and reuse passwords, so a compromise of one database containing password hashes can result in account access on other sites, making password hash storage of critical importance even if the other data stored is not that important.</p>

<p>If you are storing other sensitive information in your database, you should consider using a similar approach in other areas (or all areas) of your application.</p>

<h3 id="label-Tokens">Tokens<span><a href="#label-Tokens">&para;</a> <a href="#top">&uarr;</a></span></h3>

<p>Account verification, password resets, email auth, verify login change, remember, and lockout tokens all use a similar approach.  They all provide a token, in the format “account-id_long-random-string”.  By including the id of the account in the token, an attacker can only attempt to bruteforce the token for a single account, instead of being able to bruteforce tokens for all accounts at once (which would be possible if the token was just a random string).</p>

<p>Additionally, all comparisons of tokens use a timing-safe comparison function to reduce the risk of timing attacks.</p>

<h2 id="label-HMAC">HMAC<span><a href="#label-HMAC">&para;</a> <a href="#top">&uarr;</a></span></h2>

<p>By default, for backwards compatibility, <a href="../classes/Rodauth.html"><code>Rodauth</code></a> does not use HMACs, but you are strongly encouraged to use the <code>hmac_secret</code> configuration method to set an HMAC secret.  Setting an HMAC secret will enable HMACs for additional security, as described below.</p>

<h3 id="label-email_base+feature"><a href="doc/email_base_rdoc.html">email_base</a> feature<span><a href="#label-email_base+feature">&para;</a> <a href="#top">&uarr;</a></span></h3>

<p>All features that send email use this feature.  Setting <code>hmac_secret</code> will make the tokens sent via email use an HMAC, while the raw token stored in the database will not use an HMAC.  This will make it so if the tokens in the database are leaked (e.g. via an SQL injection vulnerability), they will not be usable without also having access to the <code>hmac_secret</code>.  Without an HMAC, the raw token is sent in the email, and if the tokens in the database are leaked, they will be usable.</p>

<p>To allow for an graceful transition, you can set <code>allow_raw_email_token?</code> to true temporarily.  This will allow the raw tokens in previous sent emails to still work.  This should only be set temporarily as it removes the security that <code>hmac_secret</code> adds.  Most features that send email have tokens that expire by default in 1 day.  The exception is the <a href="doc/verify_account_rdoc.html">verify_account</a> feature, which has tokens that do not expire.  For the <a href="doc/verify_account_rdoc.html">verify_account</a> feature, if the user requested an email before <code>hmac_secret</code> was set, after <code>allow_raw_email_token</code> is no longer set, they will need to request the verification email be resent, in which case they will receive an email with a token that uses an HMAC.</p>

<h3 id="label-remember+feature">remember feature<span><a href="#label-remember+feature">&para;</a> <a href="#top">&uarr;</a></span></h3>

<p>Similar to the <a href="doc/email_base_rdoc.html">email_base</a> feature, this uses HMACs for remember tokens, while storing the raw tokens in the database.  This makes it so if the raw tokens in the database are leaked, the remember tokens are not usable without knowledge of the <code>hmac_secret</code>.</p>

<p>The <code>raw_remember_token_deadline</code> configuration method can be set to allow a previously set raw remember token to be used if the deadline for the remember token is before the given time. This allows for graceful transition to using HMACs for remember tokens. By default, the deadline is 14 days after the token is created, so this should be set to 14 days after the time you enable the HMAC for the remember feature if you are using the defaults.</p>

<h3 id="label-otp+feature">otp feature<span><a href="#label-otp+feature">&para;</a> <a href="#top">&uarr;</a></span></h3>

<p>Setting <code>hmac_secret</code> will provide HMACed OTP keys to users, and would store the raw OTP keys in the database.  This will make so if the raw OTP keys in the database are leaked, they will not be usable for two factor authentication without knowledge of the <code>hmac_secret</code>.</p>

<p>Unfortunately, there can be no simple graceful transition for existing users. When introducing <code>hmac_secret</code> to a <a href="../classes/Rodauth.html"><code>Rodauth</code></a> installation that already uses the otp feature, you will have to either revoke and replace all OTP keys, set <code>otp_keys_use_hmac?</code> to false and continue to use raw OTP keys, or override <code>otp_keys_use_hmac?</code> to return false if the user was issued an OTP key before <code>hmac_secret</code> was added to the configuration, and true otherwise. <code>otp_keys_use_hmac?</code> defaults to true if <code>hmac_secret</code> is set, and false otherwise.</p>

<p>If <code>otp_keys_use_hmac?</code> is true, <a href="../classes/Rodauth.html"><code>Rodauth</code></a> will also ensure during OTP setup that the OTP key was generated by the server.  If <code>otp_keys_use_hmac?</code> is false, any OTP key in a valid format will be accepted during setup.</p>

<p>If <code>otp_keys_use_hmac?</code> is true, the jwt and otp features are in use and you are setting up OTP via JSON requests, you need to first send a POST request to the OTP setup route.  This will return an error with the <code>otp_secret</code> and <code>otp_raw_secret</code> parameters in the JSON.  These parameters should be submitted in the POST request to setup OTP, along with a valid OTP auth code for the <code>otp_secret</code>.</p>

<h3 id="label-webauthn+feature">webauthn feature<span><a href="#label-webauthn+feature">&para;</a> <a href="#top">&uarr;</a></span></h3>

<p>Setting <code>hmac_secret</code> is required to use the webauthn feature, as it is used for checking that the provided authentication challenges have not been modified.</p>

<h3 id="label-active_sessions+feature"><a href="doc/active_sessions_rdoc.html">active_sessions</a> feature<span><a href="#label-active_sessions+feature">&para;</a> <a href="#top">&uarr;</a></span></h3>

<p>Setting <code>hmac_secret</code> is required to use the <a href="doc/active_sessions_rdoc.html">active_sessions</a> feature, as the database stores an HMAC of the active session ID.</p>

<h3 id="label-single_session+feature"><a href="doc/single_session_rdoc.html">single_session</a> feature<span><a href="#label-single_session+feature">&para;</a> <a href="#top">&uarr;</a></span></h3>

<p>Setting <code>hmac_secret</code> will ensure the single session secret set in the session will be an HMACed.  This does not affect security, as the session itself should at the least by protected by an HMAC (if not encrypted). This is only done for consistency, so that the raw tokens in the database are distinct from the tokens provided to the users.  To allow for a graceful transition, <code>allow_raw_single_session_key?</code> can be set to true.</p>

<h2 id="label-PostgreSQL+Database+Setup">PostgreSQL Database Setup<span><a href="#label-PostgreSQL+Database+Setup">&para;</a> <a href="#top">&uarr;</a></span></h2>

<p>In order to get full advantages of Rodauth’s security design on PostgreSQL, multiple database accounts are involved:</p>
<ol><li>
<p>database superuser account (usually postgres)</p>
</li><li>
<p><code>app</code> account (same name as application)</p>
</li><li>
<p><code>ph</code> account (application name with <code>_password</code> appended)</p>
</li></ol>

<p>The database superuser account is used to load extensions related to the database.  The application should never be run using the database superuser account.</p>

<h3 id="label-Create+database+accounts">Create database accounts<span><a href="#label-Create+database+accounts">&para;</a> <a href="#top">&uarr;</a></span></h3>

<p>If you are currently running your application using the database superuser account, the first thing you need to do is to create the <code>app</code> database account.  It’s often best to name this account the same as the database name.</p>

<p>You should also create the <code>ph</code> database account which will handle access to the password hashes.</p>

<p>Example for PostgreSQL:</p>

<pre>createuser -U postgres ${DATABASE_NAME}
createuser -U postgres ${DATABASE_NAME}_password</pre>

<p>Note that if the database superuser account owns all of the items in the database, you’ll need to change the ownership to the database account you just created.  See <a target="_top" href="https://gist.github.com/jeremyevans/8483320">gist.github.com/jeremyevans/8483320</a> for a way to do that.</p>

<h3 id="label-Create+database">Create database<span><a href="#label-Create+database">&para;</a> <a href="#top">&uarr;</a></span></h3>

<p>In general, the <code>app</code> account is the owner of the database, since it will own most of the tables:</p>

<pre>createdb -U postgres -O ${DATABASE_NAME} ${DATABASE_NAME}</pre>

<p>Note that this is not the most secure way to develop applications.  For maximum security, you would want to use a separate database account as the owner of the tables, have the <code>app</code> account not be the owner of any tables, and specifically grant the <code>app</code> account only the minimum access it needs to work correctly.  Doing that is beyond the scope of <a href="../classes/Rodauth.html"><code>Rodauth</code></a>, though.</p>

<h3 id="label-Load+extensions">Load extensions<span><a href="#label-Load+extensions">&para;</a> <a href="#top">&uarr;</a></span></h3>

<p>If you want to use the login features for <a href="../classes/Rodauth.html"><code>Rodauth</code></a>, you need to load the citext extension if you want to support case insensitive logins.</p>

<p>Example:</p>

<pre>psql -U postgres -c &quot;CREATE EXTENSION citext&quot; ${DATABASE_NAME}</pre>

<p>Note that on Heroku, this extension can be loaded using a standard database account.  If you want logins to be case sensitive (generally considered a bad idea), you don’t need to use the PostgreSQL citext extension. Just remember to modify the migration below to use <code>String</code> instead of <code>citext</code> for the email in that case.</p>

<h3 id="label-Grant+schema+rights+-28PostgreSQL+15-2B-29">Grant schema rights (PostgreSQL 15+)<span><a href="#label-Grant+schema+rights+-28PostgreSQL+15-2B-29">&para;</a> <a href="#top">&uarr;</a></span></h3>

<p>PostgreSQL 15 changed default database security so that only the database owner has writable access to the public schema.  <a href="../classes/Rodauth.html"><code>Rodauth</code></a> expects the <code>ph</code> account to have writable access to the public schema when setting things up.  Temporarily grant that access (it will be revoked after the migration has run)</p>

<pre>psql -U postgres -c &quot;GRANT CREATE ON SCHEMA public TO ${DATABASE_NAME}_password&quot; ${DATABASE_NAME}</pre>

<h3 id="label-Using+non-default+schema">Using non-default schema<span><a href="#label-Using+non-default+schema">&para;</a> <a href="#top">&uarr;</a></span></h3>

<p>PostgreSQL sets up new tables in the public schema by default. If you would like to use separate schemas per user, you can do:</p>

<pre>psql -U postgres -c &quot;DROP SCHEMA public;&quot; ${DATABASE_NAME}
psql -U postgres -c &quot;CREATE SCHEMA AUTHORIZATION ${DATABASE_NAME};&quot;          ${DATABASE_NAME}
psql -U postgres -c &quot;CREATE SCHEMA AUTHORIZATION ${DATABASE_NAME}_password;&quot; ${DATABASE_NAME}
psql -U postgres -c &quot;GRANT USAGE ON SCHEMA ${DATABASE_NAME}          TO ${DATABASE_NAME}_password;&quot; ${DATABASE_NAME}
psql -U postgres -c &quot;GRANT USAGE ON SCHEMA ${DATABASE_NAME}_password TO ${DATABASE_NAME};&quot;          ${DATABASE_NAME}</pre>

<p>You’ll need to modify the code to load the extension to specify the schema:</p>

<pre>psql -U postgres -c &quot;CREATE EXTENSION citext SCHEMA ${DATABASE_NAME}&quot; ${DATABASE_NAME}</pre>

<p>When running the migration for the <code>ph</code> user you’ll need to modify a couple things for the schema changes:</p>

<pre>create_table(:account_password_hashes) do
  foreign_key :id, Sequel[:${DATABASE_NAME}][:accounts], primary_key: true, type: :Bignum
  String :password_hash, null: false
end
Rodauth.create_database_authentication_functions(self, table_name: Sequel[:${DATABASE_NAME}_password][:account_password_hashes])

# if using the disallow_password_reuse feature:
create_table(:account_previous_password_hashes) do
  primary_key :id, type: :Bignum
  foreign_key :account_id, Sequel[:${DATABASE_NAME}][:accounts], type: :Bignum
  String :password_hash, null: false
end
Rodauth.create_database_previous_password_check_functions(self, table_name: Sequel[:${DATABASE_NAME}_password][:account_previous_password_hashes])</pre>

<p>You’ll also need to use the following <a href="../classes/Rodauth.html"><code>Rodauth</code></a> configuration methods so that the app account calls functions in a separate schema:</p>

<pre>function_name do |name|
  &quot;${DATABASE_NAME}_password.#{name}&quot;
end
password_hash_table Sequel[:${DATABASE_NAME}_password][:account_password_hashes]

# if using the disallow_password_reuse feature:
previous_password_hash_table Sequel[:${DATABASE_NAME}_password][:account_previous_password_hashes]</pre>

<h2 id="label-MySQL+Database+Setup">MySQL Database Setup<span><a href="#label-MySQL+Database+Setup">&para;</a> <a href="#top">&uarr;</a></span></h2>

<p>MySQL does not have the concept of object owners, and MySQL’s GRANT/REVOKE support is much more limited than PostgreSQL’s. When using MySQL, it is recommended to GRANT the <code>ph</code> account ALL privileges on the database, including the ability to GRANT permissions to the <code>app</code> account:</p>

<pre>CREATE USER &#39;${DATABASE_NAME}&#39;@&#39;localhost&#39; IDENTIFIED BY &#39;${PASSWORD}&#39;;
CREATE USER &#39;${DATABASE_NAME}_password&#39;@&#39;localhost&#39; IDENTIFIED BY &#39;${OTHER_PASSWORD}&#39;;
GRANT ALL ON ${DATABASE_NAME}.* TO &#39;${DATABASE_NAME}_password&#39;@&#39;localhost&#39; WITH GRANT OPTION;</pre>

<p>You should run all migrations as the <code>ph</code> account, and GRANT specific access to the <code>app</code> account as needed.</p>

<p>Adding the database functions on MySQL may require setting the <code>log_bin_trust_function_creators=1</code> setting in the MySQL configuration.</p>

<h2 id="label-Microsoft+SQL+Server+Database+Setup">Microsoft SQL Server Database Setup<span><a href="#label-Microsoft+SQL+Server+Database+Setup">&para;</a> <a href="#top">&uarr;</a></span></h2>

<p>Microsoft SQL Server has a concept of database owners, but similar to MySQL usage it’s recommended to use the <code>ph</code> account as the superuser for the database, and have it GRANT permissions to the <code>app</code> account:</p>

<pre>CREATE LOGIN rodauth_test WITH PASSWORD = &#39;rodauth_test&#39;;
CREATE LOGIN rodauth_test_password WITH PASSWORD = &#39;rodauth_test&#39;;
CREATE DATABASE rodauth_test;
USE rodauth_test;
CREATE USER rodauth_test FOR LOGIN rodauth_test;
GRANT CONNECT, EXECUTE TO rodauth_test;
EXECUTE sp_changedbowner &#39;rodauth_test_password&#39;;</pre>

<p>You should run all migrations as the <code>ph</code> account, and GRANT specific access to the <code>app</code> account as needed.</p>

<h2 id="label-Creating+tables">Creating tables<span><a href="#label-Creating+tables">&para;</a> <a href="#top">&uarr;</a></span></h2>

<p>Because two different database accounts are used, two different migrations are required, one for each database account.  Here are example migrations. You can modify them to add support for additional columns, or remove tables or columns related to features that you don’t need.</p>

<p>First migration.  On PostgreSQL, this should be run with the <code>app</code> account, on MySQL and Microsoft SQL Server this should be run with the <code>ph</code> account.</p>

<p>Note that these migrations require Sequel 4.35.0+.</p>

<pre class="ruby"><span class="ruby-constant">Sequel</span>.<span class="ruby-identifier">migration</span> <span class="ruby-keyword">do</span>
  <span class="ruby-identifier">up</span> <span class="ruby-keyword">do</span>
    <span class="ruby-identifier">extension</span> <span class="ruby-value">:date_arithmetic</span>

    <span class="ruby-comment"># Used by the account verification and close account features</span>
    <span class="ruby-identifier">create_table</span>(<span class="ruby-value">:account_statuses</span>) <span class="ruby-keyword">do</span>
      <span class="ruby-constant">Integer</span> <span class="ruby-value">:id</span>, <span class="ruby-value">primary_key:</span> <span class="ruby-keyword">true</span>
      <span class="ruby-constant">String</span> <span class="ruby-value">:name</span>, <span class="ruby-value">null:</span> <span class="ruby-keyword">false</span>, <span class="ruby-value">unique:</span> <span class="ruby-keyword">true</span>
    <span class="ruby-keyword">end</span>
    <span class="ruby-identifier">from</span>(<span class="ruby-value">:account_statuses</span>).<span class="ruby-identifier">import</span>([<span class="ruby-value">:id</span>, <span class="ruby-value">:name</span>], [[<span class="ruby-value">1</span>, <span class="ruby-string">&#39;Unverified&#39;</span>], [<span class="ruby-value">2</span>, <span class="ruby-string">&#39;Verified&#39;</span>], [<span class="ruby-value">3</span>, <span class="ruby-string">&#39;Closed&#39;</span>]])

    <span class="ruby-identifier">db</span> = <span class="ruby-keyword">self</span>
    <span class="ruby-identifier">create_table</span>(<span class="ruby-value">:accounts</span>) <span class="ruby-keyword">do</span>
      <span class="ruby-identifier">primary_key</span> <span class="ruby-value">:id</span>, <span class="ruby-value">type:</span> <span class="ruby-value">:Bignum</span>
      <span class="ruby-identifier">foreign_key</span> <span class="ruby-value">:status_id</span>, <span class="ruby-value">:account_statuses</span>, <span class="ruby-value">null:</span> <span class="ruby-keyword">false</span>, <span class="ruby-value">default:</span> <span class="ruby-value">1</span>
      <span class="ruby-keyword">if</span> <span class="ruby-identifier">db</span>.<span class="ruby-identifier">database_type</span> <span class="ruby-operator">==</span> <span class="ruby-value">:postgres</span>
        <span class="ruby-identifier">citext</span> <span class="ruby-value">:email</span>, <span class="ruby-value">null:</span> <span class="ruby-keyword">false</span>
        <span class="ruby-identifier">constraint</span> <span class="ruby-value">:valid_email</span>, <span class="ruby-value">email:</span> <span class="ruby-regexp">/^[^,;@ \r\n]+@[^,@; \r\n]+\.[^,@; \r\n]+$/</span>
      <span class="ruby-keyword">else</span>
        <span class="ruby-constant">String</span> <span class="ruby-value">:email</span>, <span class="ruby-value">null:</span> <span class="ruby-keyword">false</span>
      <span class="ruby-keyword">end</span>
      <span class="ruby-keyword">if</span> <span class="ruby-identifier">db</span>.<span class="ruby-identifier">supports_partial_indexes?</span>
        <span class="ruby-identifier">index</span> <span class="ruby-value">:email</span>, <span class="ruby-value">unique:</span> <span class="ruby-keyword">true</span>, <span class="ruby-value">where:</span> {<span class="ruby-value">status_id:</span> [<span class="ruby-value">1</span>, <span class="ruby-value">2</span>]}
      <span class="ruby-keyword">else</span>
        <span class="ruby-identifier">index</span> <span class="ruby-value">:email</span>, <span class="ruby-value">unique:</span> <span class="ruby-keyword">true</span>
      <span class="ruby-keyword">end</span>
    <span class="ruby-keyword">end</span>

    <span class="ruby-identifier">deadline_opts</span> = <span class="ruby-identifier">proc</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">days</span><span class="ruby-operator">|</span>
      <span class="ruby-keyword">if</span> <span class="ruby-identifier">database_type</span> <span class="ruby-operator">==</span> <span class="ruby-value">:mysql</span>
        {<span class="ruby-value">null:</span> <span class="ruby-keyword">false</span>}
      <span class="ruby-keyword">else</span>
        {<span class="ruby-value">null:</span> <span class="ruby-keyword">false</span>, <span class="ruby-value">default:</span> <span class="ruby-constant">Sequel</span>.<span class="ruby-identifier">date_add</span>(<span class="ruby-constant">Sequel</span><span class="ruby-operator">::</span><span class="ruby-constant">CURRENT_TIMESTAMP</span>, <span class="ruby-value">days:</span> <span class="ruby-identifier">days</span>)}
      <span class="ruby-keyword">end</span>
    <span class="ruby-keyword">end</span>

    <span class="ruby-comment"># Used by the audit logging feature</span>
    <span class="ruby-identifier">json_type</span> = <span class="ruby-keyword">case</span> <span class="ruby-identifier">database_type</span>
    <span class="ruby-keyword">when</span> <span class="ruby-value">:postgres</span>
      <span class="ruby-value">:jsonb</span>
    <span class="ruby-keyword">when</span> <span class="ruby-value">:sqlite</span>, <span class="ruby-value">:mysql</span>
      <span class="ruby-value">:json</span>
    <span class="ruby-keyword">else</span>
      <span class="ruby-constant">String</span>
    <span class="ruby-keyword">end</span>
    <span class="ruby-identifier">create_table</span>(<span class="ruby-value">:account_authentication_audit_logs</span>) <span class="ruby-keyword">do</span>
      <span class="ruby-identifier">primary_key</span> <span class="ruby-value">:id</span>, <span class="ruby-value">type:</span> <span class="ruby-value">:Bignum</span>
      <span class="ruby-identifier">foreign_key</span> <span class="ruby-value">:account_id</span>, <span class="ruby-value">:accounts</span>, <span class="ruby-value">null:</span> <span class="ruby-keyword">false</span>, <span class="ruby-value">type:</span> <span class="ruby-value">:Bignum</span>
      <span class="ruby-constant">DateTime</span> <span class="ruby-value">:at</span>, <span class="ruby-value">null:</span> <span class="ruby-keyword">false</span>, <span class="ruby-value">default:</span> <span class="ruby-constant">Sequel</span><span class="ruby-operator">::</span><span class="ruby-constant">CURRENT_TIMESTAMP</span>
      <span class="ruby-constant">String</span> <span class="ruby-value">:message</span>, <span class="ruby-value">null:</span> <span class="ruby-keyword">false</span>
      <span class="ruby-identifier">column</span> <span class="ruby-value">:metadata</span>, <span class="ruby-identifier">json_type</span>
      <span class="ruby-identifier">index</span> [<span class="ruby-value">:account_id</span>, <span class="ruby-value">:at</span>], <span class="ruby-value">name:</span> <span class="ruby-value">:audit_account_at_idx</span>
      <span class="ruby-identifier">index</span> <span class="ruby-value">:at</span>, <span class="ruby-value">name:</span> <span class="ruby-value">:audit_at_idx</span>
    <span class="ruby-keyword">end</span>

    <span class="ruby-comment"># Used by the password reset feature</span>
    <span class="ruby-identifier">create_table</span>(<span class="ruby-value">:account_password_reset_keys</span>) <span class="ruby-keyword">do</span>
      <span class="ruby-identifier">foreign_key</span> <span class="ruby-value">:id</span>, <span class="ruby-value">:accounts</span>, <span class="ruby-value">primary_key:</span> <span class="ruby-keyword">true</span>, <span class="ruby-value">type:</span> <span class="ruby-value">:Bignum</span>
      <span class="ruby-constant">String</span> <span class="ruby-value">:key</span>, <span class="ruby-value">null:</span> <span class="ruby-keyword">false</span>
      <span class="ruby-constant">DateTime</span> <span class="ruby-value">:deadline</span>, <span class="ruby-identifier">deadline_opts</span>[<span class="ruby-value">1</span>]
      <span class="ruby-constant">DateTime</span> <span class="ruby-value">:email_last_sent</span>, <span class="ruby-value">null:</span> <span class="ruby-keyword">false</span>, <span class="ruby-value">default:</span> <span class="ruby-constant">Sequel</span><span class="ruby-operator">::</span><span class="ruby-constant">CURRENT_TIMESTAMP</span>
    <span class="ruby-keyword">end</span>

    <span class="ruby-comment"># Used by the jwt refresh feature</span>
    <span class="ruby-identifier">create_table</span>(<span class="ruby-value">:account_jwt_refresh_keys</span>) <span class="ruby-keyword">do</span>
      <span class="ruby-identifier">primary_key</span> <span class="ruby-value">:id</span>, <span class="ruby-value">type:</span> <span class="ruby-value">:Bignum</span>
      <span class="ruby-identifier">foreign_key</span> <span class="ruby-value">:account_id</span>, <span class="ruby-value">:accounts</span>, <span class="ruby-value">null:</span> <span class="ruby-keyword">false</span>, <span class="ruby-value">type:</span> <span class="ruby-value">:Bignum</span>
      <span class="ruby-constant">String</span> <span class="ruby-value">:key</span>, <span class="ruby-value">null:</span> <span class="ruby-keyword">false</span>
      <span class="ruby-constant">DateTime</span> <span class="ruby-value">:deadline</span>, <span class="ruby-identifier">deadline_opts</span>[<span class="ruby-value">1</span>]
      <span class="ruby-identifier">index</span> <span class="ruby-value">:account_id</span>, <span class="ruby-value">name:</span> <span class="ruby-value">:account_jwt_rk_account_id_idx</span>
    <span class="ruby-keyword">end</span>

    <span class="ruby-comment"># Used by the account verification feature</span>
    <span class="ruby-identifier">create_table</span>(<span class="ruby-value">:account_verification_keys</span>) <span class="ruby-keyword">do</span>
      <span class="ruby-identifier">foreign_key</span> <span class="ruby-value">:id</span>, <span class="ruby-value">:accounts</span>, <span class="ruby-value">primary_key:</span> <span class="ruby-keyword">true</span>, <span class="ruby-value">type:</span> <span class="ruby-value">:Bignum</span>
      <span class="ruby-constant">String</span> <span class="ruby-value">:key</span>, <span class="ruby-value">null:</span> <span class="ruby-keyword">false</span>
      <span class="ruby-constant">DateTime</span> <span class="ruby-value">:requested_at</span>, <span class="ruby-value">null:</span> <span class="ruby-keyword">false</span>, <span class="ruby-value">default:</span> <span class="ruby-constant">Sequel</span><span class="ruby-operator">::</span><span class="ruby-constant">CURRENT_TIMESTAMP</span>
      <span class="ruby-constant">DateTime</span> <span class="ruby-value">:email_last_sent</span>, <span class="ruby-value">null:</span> <span class="ruby-keyword">false</span>, <span class="ruby-value">default:</span> <span class="ruby-constant">Sequel</span><span class="ruby-operator">::</span><span class="ruby-constant">CURRENT_TIMESTAMP</span>
    <span class="ruby-keyword">end</span>

    <span class="ruby-comment"># Used by the verify login change feature</span>
    <span class="ruby-identifier">create_table</span>(<span class="ruby-value">:account_login_change_keys</span>) <span class="ruby-keyword">do</span>
      <span class="ruby-identifier">foreign_key</span> <span class="ruby-value">:id</span>, <span class="ruby-value">:accounts</span>, <span class="ruby-value">primary_key:</span> <span class="ruby-keyword">true</span>, <span class="ruby-value">type:</span> <span class="ruby-value">:Bignum</span>
      <span class="ruby-constant">String</span> <span class="ruby-value">:key</span>, <span class="ruby-value">null:</span> <span class="ruby-keyword">false</span>
      <span class="ruby-constant">String</span> <span class="ruby-value">:login</span>, <span class="ruby-value">null:</span> <span class="ruby-keyword">false</span>
      <span class="ruby-constant">DateTime</span> <span class="ruby-value">:deadline</span>, <span class="ruby-identifier">deadline_opts</span>[<span class="ruby-value">1</span>]
    <span class="ruby-keyword">end</span>

    <span class="ruby-comment"># Used by the remember me feature</span>
    <span class="ruby-identifier">create_table</span>(<span class="ruby-value">:account_remember_keys</span>) <span class="ruby-keyword">do</span>
      <span class="ruby-identifier">foreign_key</span> <span class="ruby-value">:id</span>, <span class="ruby-value">:accounts</span>, <span class="ruby-value">primary_key:</span> <span class="ruby-keyword">true</span>, <span class="ruby-value">type:</span> <span class="ruby-value">:Bignum</span>
      <span class="ruby-constant">String</span> <span class="ruby-value">:key</span>, <span class="ruby-value">null:</span> <span class="ruby-keyword">false</span>
      <span class="ruby-constant">DateTime</span> <span class="ruby-value">:deadline</span>, <span class="ruby-identifier">deadline_opts</span>[<span class="ruby-value">14</span>]
    <span class="ruby-keyword">end</span>

    <span class="ruby-comment"># Used by the lockout feature</span>
    <span class="ruby-identifier">create_table</span>(<span class="ruby-value">:account_login_failures</span>) <span class="ruby-keyword">do</span>
      <span class="ruby-identifier">foreign_key</span> <span class="ruby-value">:id</span>, <span class="ruby-value">:accounts</span>, <span class="ruby-value">primary_key:</span> <span class="ruby-keyword">true</span>, <span class="ruby-value">type:</span> <span class="ruby-value">:Bignum</span>
      <span class="ruby-constant">Integer</span> <span class="ruby-value">:number</span>, <span class="ruby-value">null:</span> <span class="ruby-keyword">false</span>, <span class="ruby-value">default:</span> <span class="ruby-value">1</span>
    <span class="ruby-keyword">end</span>
    <span class="ruby-identifier">create_table</span>(<span class="ruby-value">:account_lockouts</span>) <span class="ruby-keyword">do</span>
      <span class="ruby-identifier">foreign_key</span> <span class="ruby-value">:id</span>, <span class="ruby-value">:accounts</span>, <span class="ruby-value">primary_key:</span> <span class="ruby-keyword">true</span>, <span class="ruby-value">type:</span> <span class="ruby-value">:Bignum</span>
      <span class="ruby-constant">String</span> <span class="ruby-value">:key</span>, <span class="ruby-value">null:</span> <span class="ruby-keyword">false</span>
      <span class="ruby-constant">DateTime</span> <span class="ruby-value">:deadline</span>, <span class="ruby-identifier">deadline_opts</span>[<span class="ruby-value">1</span>]
      <span class="ruby-constant">DateTime</span> <span class="ruby-value">:email_last_sent</span>
    <span class="ruby-keyword">end</span>

    <span class="ruby-comment"># Used by the email auth feature</span>
    <span class="ruby-identifier">create_table</span>(<span class="ruby-value">:account_email_auth_keys</span>) <span class="ruby-keyword">do</span>
      <span class="ruby-identifier">foreign_key</span> <span class="ruby-value">:id</span>, <span class="ruby-value">:accounts</span>, <span class="ruby-value">primary_key:</span> <span class="ruby-keyword">true</span>, <span class="ruby-value">type:</span> <span class="ruby-value">:Bignum</span>
      <span class="ruby-constant">String</span> <span class="ruby-value">:key</span>, <span class="ruby-value">null:</span> <span class="ruby-keyword">false</span>
      <span class="ruby-constant">DateTime</span> <span class="ruby-value">:deadline</span>, <span class="ruby-identifier">deadline_opts</span>[<span class="ruby-value">1</span>]
      <span class="ruby-constant">DateTime</span> <span class="ruby-value">:email_last_sent</span>, <span class="ruby-value">null:</span> <span class="ruby-keyword">false</span>, <span class="ruby-value">default:</span> <span class="ruby-constant">Sequel</span><span class="ruby-operator">::</span><span class="ruby-constant">CURRENT_TIMESTAMP</span>
    <span class="ruby-keyword">end</span>

    <span class="ruby-comment"># Used by the password expiration feature</span>
    <span class="ruby-identifier">create_table</span>(<span class="ruby-value">:account_password_change_times</span>) <span class="ruby-keyword">do</span>
      <span class="ruby-identifier">foreign_key</span> <span class="ruby-value">:id</span>, <span class="ruby-value">:accounts</span>, <span class="ruby-value">primary_key:</span> <span class="ruby-keyword">true</span>, <span class="ruby-value">type:</span> <span class="ruby-value">:Bignum</span>
      <span class="ruby-constant">DateTime</span> <span class="ruby-value">:changed_at</span>, <span class="ruby-value">null:</span> <span class="ruby-keyword">false</span>, <span class="ruby-value">default:</span> <span class="ruby-constant">Sequel</span><span class="ruby-operator">::</span><span class="ruby-constant">CURRENT_TIMESTAMP</span>
    <span class="ruby-keyword">end</span>

    <span class="ruby-comment"># Used by the account expiration feature</span>
    <span class="ruby-identifier">create_table</span>(<span class="ruby-value">:account_activity_times</span>) <span class="ruby-keyword">do</span>
      <span class="ruby-identifier">foreign_key</span> <span class="ruby-value">:id</span>, <span class="ruby-value">:accounts</span>, <span class="ruby-value">primary_key:</span> <span class="ruby-keyword">true</span>, <span class="ruby-value">type:</span> <span class="ruby-value">:Bignum</span>
      <span class="ruby-constant">DateTime</span> <span class="ruby-value">:last_activity_at</span>, <span class="ruby-value">null:</span> <span class="ruby-keyword">false</span>
      <span class="ruby-constant">DateTime</span> <span class="ruby-value">:last_login_at</span>, <span class="ruby-value">null:</span> <span class="ruby-keyword">false</span>
      <span class="ruby-constant">DateTime</span> <span class="ruby-value">:expired_at</span>
    <span class="ruby-keyword">end</span>

    <span class="ruby-comment"># Used by the single session feature</span>
    <span class="ruby-identifier">create_table</span>(<span class="ruby-value">:account_session_keys</span>) <span class="ruby-keyword">do</span>
      <span class="ruby-identifier">foreign_key</span> <span class="ruby-value">:id</span>, <span class="ruby-value">:accounts</span>, <span class="ruby-value">primary_key:</span> <span class="ruby-keyword">true</span>, <span class="ruby-value">type:</span> <span class="ruby-value">:Bignum</span>
      <span class="ruby-constant">String</span> <span class="ruby-value">:key</span>, <span class="ruby-value">null:</span> <span class="ruby-keyword">false</span>
    <span class="ruby-keyword">end</span>

    <span class="ruby-comment"># Used by the active sessions feature</span>
    <span class="ruby-identifier">create_table</span>(<span class="ruby-value">:account_active_session_keys</span>) <span class="ruby-keyword">do</span>
      <span class="ruby-identifier">foreign_key</span> <span class="ruby-value">:account_id</span>, <span class="ruby-value">:accounts</span>, <span class="ruby-value">type:</span> <span class="ruby-value">:Bignum</span>
      <span class="ruby-constant">String</span> <span class="ruby-value">:session_id</span>
      <span class="ruby-constant">Time</span> <span class="ruby-value">:created_at</span>, <span class="ruby-value">null:</span> <span class="ruby-keyword">false</span>, <span class="ruby-value">default:</span> <span class="ruby-constant">Sequel</span><span class="ruby-operator">::</span><span class="ruby-constant">CURRENT_TIMESTAMP</span>
      <span class="ruby-constant">Time</span> <span class="ruby-value">:last_use</span>, <span class="ruby-value">null:</span> <span class="ruby-keyword">false</span>, <span class="ruby-value">default:</span> <span class="ruby-constant">Sequel</span><span class="ruby-operator">::</span><span class="ruby-constant">CURRENT_TIMESTAMP</span>
      <span class="ruby-identifier">primary_key</span> [<span class="ruby-value">:account_id</span>, <span class="ruby-value">:session_id</span>]
    <span class="ruby-keyword">end</span>

    <span class="ruby-comment"># Used by the webauthn feature</span>
    <span class="ruby-identifier">create_table</span>(<span class="ruby-value">:account_webauthn_user_ids</span>) <span class="ruby-keyword">do</span>
      <span class="ruby-identifier">foreign_key</span> <span class="ruby-value">:id</span>, <span class="ruby-value">:accounts</span>, <span class="ruby-value">primary_key:</span> <span class="ruby-keyword">true</span>, <span class="ruby-value">type:</span> <span class="ruby-value">:Bignum</span>
      <span class="ruby-constant">String</span> <span class="ruby-value">:webauthn_id</span>, <span class="ruby-value">null:</span> <span class="ruby-keyword">false</span>
    <span class="ruby-keyword">end</span>
    <span class="ruby-identifier">create_table</span>(<span class="ruby-value">:account_webauthn_keys</span>) <span class="ruby-keyword">do</span>
      <span class="ruby-identifier">foreign_key</span> <span class="ruby-value">:account_id</span>, <span class="ruby-value">:accounts</span>, <span class="ruby-value">type:</span> <span class="ruby-value">:Bignum</span>
      <span class="ruby-constant">String</span> <span class="ruby-value">:webauthn_id</span>
      <span class="ruby-constant">String</span> <span class="ruby-value">:public_key</span>, <span class="ruby-value">null:</span> <span class="ruby-keyword">false</span>
      <span class="ruby-constant">Integer</span> <span class="ruby-value">:sign_count</span>, <span class="ruby-value">null:</span> <span class="ruby-keyword">false</span>
      <span class="ruby-constant">Time</span> <span class="ruby-value">:last_use</span>, <span class="ruby-value">null:</span> <span class="ruby-keyword">false</span>, <span class="ruby-value">default:</span> <span class="ruby-constant">Sequel</span><span class="ruby-operator">::</span><span class="ruby-constant">CURRENT_TIMESTAMP</span>
      <span class="ruby-identifier">primary_key</span> [<span class="ruby-value">:account_id</span>, <span class="ruby-value">:webauthn_id</span>]
    <span class="ruby-keyword">end</span>

    <span class="ruby-comment"># Used by the otp feature</span>
    <span class="ruby-identifier">create_table</span>(<span class="ruby-value">:account_otp_keys</span>) <span class="ruby-keyword">do</span>
      <span class="ruby-identifier">foreign_key</span> <span class="ruby-value">:id</span>, <span class="ruby-value">:accounts</span>, <span class="ruby-value">primary_key:</span> <span class="ruby-keyword">true</span>, <span class="ruby-value">type:</span> <span class="ruby-value">:Bignum</span>
      <span class="ruby-constant">String</span> <span class="ruby-value">:key</span>, <span class="ruby-value">null:</span> <span class="ruby-keyword">false</span>
      <span class="ruby-constant">Integer</span> <span class="ruby-value">:num_failures</span>, <span class="ruby-value">null:</span> <span class="ruby-keyword">false</span>, <span class="ruby-value">default:</span> <span class="ruby-value">0</span>
      <span class="ruby-constant">Time</span> <span class="ruby-value">:last_use</span>, <span class="ruby-value">null:</span> <span class="ruby-keyword">false</span>, <span class="ruby-value">default:</span> <span class="ruby-constant">Sequel</span><span class="ruby-operator">::</span><span class="ruby-constant">CURRENT_TIMESTAMP</span>
    <span class="ruby-keyword">end</span>

    <span class="ruby-comment"># Used by the otp_unlock feature</span>
    <span class="ruby-identifier">create_table</span>(<span class="ruby-value">:account_otp_unlocks</span>) <span class="ruby-keyword">do</span>
      <span class="ruby-identifier">foreign_key</span> <span class="ruby-value">:id</span>, <span class="ruby-value">:accounts</span>, <span class="ruby-value">primary_key:</span> <span class="ruby-keyword">true</span>, <span class="ruby-value">type:</span> <span class="ruby-value">:Bignum</span>
      <span class="ruby-constant">Integer</span> <span class="ruby-value">:num_successes</span>, <span class="ruby-value">null:</span> <span class="ruby-keyword">false</span>, <span class="ruby-value">default:</span> <span class="ruby-value">1</span>
      <span class="ruby-constant">Time</span> <span class="ruby-value">:next_auth_attempt_after</span>, <span class="ruby-value">null:</span> <span class="ruby-keyword">false</span>, <span class="ruby-value">default:</span> <span class="ruby-constant">Sequel</span><span class="ruby-operator">::</span><span class="ruby-constant">CURRENT_TIMESTAMP</span>
    <span class="ruby-keyword">end</span>

    <span class="ruby-comment"># Used by the recovery codes feature</span>
    <span class="ruby-identifier">create_table</span>(<span class="ruby-value">:account_recovery_codes</span>) <span class="ruby-keyword">do</span>
      <span class="ruby-identifier">foreign_key</span> <span class="ruby-value">:id</span>, <span class="ruby-value">:accounts</span>, <span class="ruby-value">type:</span> <span class="ruby-value">:Bignum</span>
      <span class="ruby-constant">String</span> <span class="ruby-value">:code</span>
      <span class="ruby-identifier">primary_key</span> [<span class="ruby-value">:id</span>, <span class="ruby-value">:code</span>]
    <span class="ruby-keyword">end</span>

    <span class="ruby-comment"># Used by the sms codes feature</span>
    <span class="ruby-identifier">create_table</span>(<span class="ruby-value">:account_sms_codes</span>) <span class="ruby-keyword">do</span>
      <span class="ruby-identifier">foreign_key</span> <span class="ruby-value">:id</span>, <span class="ruby-value">:accounts</span>, <span class="ruby-value">primary_key:</span> <span class="ruby-keyword">true</span>, <span class="ruby-value">type:</span> <span class="ruby-value">:Bignum</span>
      <span class="ruby-constant">String</span> <span class="ruby-value">:phone_number</span>, <span class="ruby-value">null:</span> <span class="ruby-keyword">false</span>
      <span class="ruby-constant">Integer</span> <span class="ruby-value">:num_failures</span>
      <span class="ruby-constant">String</span> <span class="ruby-value">:code</span>
      <span class="ruby-constant">DateTime</span> <span class="ruby-value">:code_issued_at</span>, <span class="ruby-value">null:</span> <span class="ruby-keyword">false</span>, <span class="ruby-value">default:</span> <span class="ruby-constant">Sequel</span><span class="ruby-operator">::</span><span class="ruby-constant">CURRENT_TIMESTAMP</span>
    <span class="ruby-keyword">end</span>

    <span class="ruby-keyword">case</span> <span class="ruby-identifier">database_type</span>
    <span class="ruby-keyword">when</span> <span class="ruby-value">:postgres</span>
      <span class="ruby-identifier">user</span> = <span class="ruby-identifier">get</span>(<span class="ruby-constant">Sequel</span>.<span class="ruby-identifier">lit</span>(<span class="ruby-string">&#39;current_user&#39;</span>)) <span class="ruby-operator">+</span> <span class="ruby-string">&#39;_password&#39;</span>
      <span class="ruby-identifier">run</span> <span class="ruby-node">&quot;GRANT REFERENCES ON accounts TO #{user}&quot;</span>
    <span class="ruby-keyword">when</span> <span class="ruby-value">:mysql</span>, <span class="ruby-value">:mssql</span>
      <span class="ruby-identifier">user</span> = <span class="ruby-keyword">if</span> <span class="ruby-identifier">database_type</span> <span class="ruby-operator">==</span> <span class="ruby-value">:mysql</span>
        <span class="ruby-identifier">get</span>(<span class="ruby-constant">Sequel</span>.<span class="ruby-identifier">lit</span>(<span class="ruby-string">&#39;current_user&#39;</span>)).<span class="ruby-identifier">sub</span>(<span class="ruby-regexp">/_password@/</span>, <span class="ruby-string">&#39;@&#39;</span>)
      <span class="ruby-keyword">else</span>
        <span class="ruby-identifier">get</span>(<span class="ruby-constant">Sequel</span>.<span class="ruby-identifier">function</span>(<span class="ruby-value">:DB_NAME</span>))
      <span class="ruby-keyword">end</span>
      <span class="ruby-identifier">run</span> <span class="ruby-node">&quot;GRANT SELECT, INSERT, UPDATE, DELETE ON account_statuses TO #{user}&quot;</span>
      <span class="ruby-identifier">run</span> <span class="ruby-node">&quot;GRANT SELECT, INSERT, UPDATE, DELETE ON accounts TO #{user}&quot;</span>
      <span class="ruby-identifier">run</span> <span class="ruby-node">&quot;GRANT SELECT, INSERT, UPDATE, DELETE ON account_authentication_audit_logs TO #{user}&quot;</span>
      <span class="ruby-identifier">run</span> <span class="ruby-node">&quot;GRANT SELECT, INSERT, UPDATE, DELETE ON account_password_reset_keys TO #{user}&quot;</span>
      <span class="ruby-identifier">run</span> <span class="ruby-node">&quot;GRANT SELECT, INSERT, UPDATE, DELETE ON account_jwt_refresh_keys TO #{user}&quot;</span>
      <span class="ruby-identifier">run</span> <span class="ruby-node">&quot;GRANT SELECT, INSERT, UPDATE, DELETE ON account_verification_keys TO #{user}&quot;</span>
      <span class="ruby-identifier">run</span> <span class="ruby-node">&quot;GRANT SELECT, INSERT, UPDATE, DELETE ON account_login_change_keys TO #{user}&quot;</span>
      <span class="ruby-identifier">run</span> <span class="ruby-node">&quot;GRANT SELECT, INSERT, UPDATE, DELETE ON account_remember_keys TO #{user}&quot;</span>
      <span class="ruby-identifier">run</span> <span class="ruby-node">&quot;GRANT SELECT, INSERT, UPDATE, DELETE ON account_login_failures TO #{user}&quot;</span>
      <span class="ruby-identifier">run</span> <span class="ruby-node">&quot;GRANT SELECT, INSERT, UPDATE, DELETE ON account_email_auth_keys TO #{user}&quot;</span>
      <span class="ruby-identifier">run</span> <span class="ruby-node">&quot;GRANT SELECT, INSERT, UPDATE, DELETE ON account_lockouts TO #{user}&quot;</span>
      <span class="ruby-identifier">run</span> <span class="ruby-node">&quot;GRANT SELECT, INSERT, UPDATE, DELETE ON account_password_change_times TO #{user}&quot;</span>
      <span class="ruby-identifier">run</span> <span class="ruby-node">&quot;GRANT SELECT, INSERT, UPDATE, DELETE ON account_activity_times TO #{user}&quot;</span>
      <span class="ruby-identifier">run</span> <span class="ruby-node">&quot;GRANT SELECT, INSERT, UPDATE, DELETE ON account_session_keys TO #{user}&quot;</span>
      <span class="ruby-identifier">run</span> <span class="ruby-node">&quot;GRANT SELECT, INSERT, UPDATE, DELETE ON account_active_session_keys TO #{user}&quot;</span>
      <span class="ruby-identifier">run</span> <span class="ruby-node">&quot;GRANT SELECT, INSERT, UPDATE, DELETE ON account_webauthn_user_ids TO #{user}&quot;</span>
      <span class="ruby-identifier">run</span> <span class="ruby-node">&quot;GRANT SELECT, INSERT, UPDATE, DELETE ON account_webauthn_keys TO #{user}&quot;</span>
      <span class="ruby-identifier">run</span> <span class="ruby-node">&quot;GRANT SELECT, INSERT, UPDATE, DELETE ON account_otp_keys TO #{user}&quot;</span>
      <span class="ruby-identifier">run</span> <span class="ruby-node">&quot;GRANT SELECT, INSERT, UPDATE, DELETE ON account_otp_unlocks TO #{user}&quot;</span>
      <span class="ruby-identifier">run</span> <span class="ruby-node">&quot;GRANT SELECT, INSERT, UPDATE, DELETE ON account_recovery_codes TO #{user}&quot;</span>
      <span class="ruby-identifier">run</span> <span class="ruby-node">&quot;GRANT SELECT, INSERT, UPDATE, DELETE ON account_sms_codes TO #{user}&quot;</span>
    <span class="ruby-keyword">end</span>
  <span class="ruby-keyword">end</span>

  <span class="ruby-identifier">down</span> <span class="ruby-keyword">do</span>
    <span class="ruby-identifier">drop_table</span>(<span class="ruby-value">:account_sms_codes</span>,
               <span class="ruby-value">:account_recovery_codes</span>,
               <span class="ruby-value">:account_otp_unlocks</span>,
               <span class="ruby-value">:account_otp_keys</span>,
               <span class="ruby-value">:account_webauthn_keys</span>,
               <span class="ruby-value">:account_webauthn_user_ids</span>,
               <span class="ruby-value">:account_session_keys</span>,
               <span class="ruby-value">:account_active_session_keys</span>,
               <span class="ruby-value">:account_activity_times</span>,
               <span class="ruby-value">:account_password_change_times</span>,
               <span class="ruby-value">:account_email_auth_keys</span>,
               <span class="ruby-value">:account_lockouts</span>,
               <span class="ruby-value">:account_login_failures</span>,
               <span class="ruby-value">:account_remember_keys</span>,
               <span class="ruby-value">:account_login_change_keys</span>,
               <span class="ruby-value">:account_verification_keys</span>,
               <span class="ruby-value">:account_jwt_refresh_keys</span>,
               <span class="ruby-value">:account_password_reset_keys</span>,
               <span class="ruby-value">:account_authentication_audit_logs</span>,
               <span class="ruby-value">:accounts</span>,
               <span class="ruby-value">:account_statuses</span>)
  <span class="ruby-keyword">end</span>
<span class="ruby-keyword">end</span>
</pre>

<p>Second migration, run using the <code>ph</code> account:</p>

<pre class="ruby"><span class="ruby-identifier">require</span> <span class="ruby-string">&#39;rodauth/migrations&#39;</span>

<span class="ruby-constant">Sequel</span>.<span class="ruby-identifier">migration</span> <span class="ruby-keyword">do</span>
  <span class="ruby-identifier">up</span> <span class="ruby-keyword">do</span>
    <span class="ruby-identifier">create_table</span>(<span class="ruby-value">:account_password_hashes</span>) <span class="ruby-keyword">do</span>
      <span class="ruby-identifier">foreign_key</span> <span class="ruby-value">:id</span>, <span class="ruby-value">:accounts</span>, <span class="ruby-value">primary_key:</span> <span class="ruby-keyword">true</span>, <span class="ruby-value">type:</span> <span class="ruby-value">:Bignum</span>
      <span class="ruby-constant">String</span> <span class="ruby-value">:password_hash</span>, <span class="ruby-value">null:</span> <span class="ruby-keyword">false</span>
    <span class="ruby-keyword">end</span>
    <span class="ruby-constant">Rodauth</span>.<span class="ruby-identifier">create_database_authentication_functions</span>(<span class="ruby-keyword">self</span>)
    <span class="ruby-keyword">case</span> <span class="ruby-identifier">database_type</span>
    <span class="ruby-keyword">when</span> <span class="ruby-value">:postgres</span>
      <span class="ruby-identifier">user</span> = <span class="ruby-identifier">get</span>(<span class="ruby-constant">Sequel</span>.<span class="ruby-identifier">lit</span>(<span class="ruby-string">&#39;current_user&#39;</span>)).<span class="ruby-identifier">sub</span>(<span class="ruby-regexp">/_password\z/</span>, <span class="ruby-string">&#39;&#39;</span>)
      <span class="ruby-identifier">run</span> <span class="ruby-string">&quot;REVOKE ALL ON account_password_hashes FROM public&quot;</span>
      <span class="ruby-identifier">run</span> <span class="ruby-string">&quot;REVOKE ALL ON FUNCTION rodauth_get_salt(int8) FROM public&quot;</span>
      <span class="ruby-identifier">run</span> <span class="ruby-string">&quot;REVOKE ALL ON FUNCTION rodauth_valid_password_hash(int8, text) FROM public&quot;</span>
      <span class="ruby-identifier">run</span> <span class="ruby-node">&quot;GRANT INSERT, UPDATE, DELETE ON account_password_hashes TO #{user}&quot;</span>
      <span class="ruby-identifier">run</span> <span class="ruby-node">&quot;GRANT SELECT(id) ON account_password_hashes TO #{user}&quot;</span>
      <span class="ruby-identifier">run</span> <span class="ruby-node">&quot;GRANT EXECUTE ON FUNCTION rodauth_get_salt(int8) TO #{user}&quot;</span>
      <span class="ruby-identifier">run</span> <span class="ruby-node">&quot;GRANT EXECUTE ON FUNCTION rodauth_valid_password_hash(int8, text) TO #{user}&quot;</span>
    <span class="ruby-keyword">when</span> <span class="ruby-value">:mysql</span>
      <span class="ruby-identifier">user</span> = <span class="ruby-identifier">get</span>(<span class="ruby-constant">Sequel</span>.<span class="ruby-identifier">lit</span>(<span class="ruby-string">&#39;current_user&#39;</span>)).<span class="ruby-identifier">sub</span>(<span class="ruby-regexp">/_password@/</span>, <span class="ruby-string">&#39;@&#39;</span>)
      <span class="ruby-identifier">db_name</span> = <span class="ruby-identifier">get</span>(<span class="ruby-constant">Sequel</span>.<span class="ruby-identifier">function</span>(<span class="ruby-value">:database</span>))
      <span class="ruby-identifier">run</span> <span class="ruby-node">&quot;GRANT EXECUTE ON #{db_name}.* TO #{user}&quot;</span>
      <span class="ruby-identifier">run</span> <span class="ruby-node">&quot;GRANT INSERT, UPDATE, DELETE ON account_password_hashes TO #{user}&quot;</span>
      <span class="ruby-identifier">run</span> <span class="ruby-node">&quot;GRANT SELECT (id) ON account_password_hashes TO #{user}&quot;</span>
    <span class="ruby-keyword">when</span> <span class="ruby-value">:mssql</span>
      <span class="ruby-identifier">user</span> = <span class="ruby-identifier">get</span>(<span class="ruby-constant">Sequel</span>.<span class="ruby-identifier">function</span>(<span class="ruby-value">:DB_NAME</span>))
      <span class="ruby-identifier">run</span> <span class="ruby-node">&quot;GRANT EXECUTE ON rodauth_get_salt TO #{user}&quot;</span>
      <span class="ruby-identifier">run</span> <span class="ruby-node">&quot;GRANT EXECUTE ON rodauth_valid_password_hash TO #{user}&quot;</span>
      <span class="ruby-identifier">run</span> <span class="ruby-node">&quot;GRANT INSERT, UPDATE, DELETE ON account_password_hashes TO #{user}&quot;</span>
      <span class="ruby-identifier">run</span> <span class="ruby-node">&quot;GRANT SELECT ON account_password_hashes(id) TO #{user}&quot;</span>
    <span class="ruby-keyword">end</span>

    <span class="ruby-comment"># Used by the disallow_password_reuse feature</span>
    <span class="ruby-identifier">create_table</span>(<span class="ruby-value">:account_previous_password_hashes</span>) <span class="ruby-keyword">do</span>
      <span class="ruby-identifier">primary_key</span> <span class="ruby-value">:id</span>, <span class="ruby-value">type:</span> <span class="ruby-value">:Bignum</span>
      <span class="ruby-identifier">foreign_key</span> <span class="ruby-value">:account_id</span>, <span class="ruby-value">:accounts</span>, <span class="ruby-value">type:</span> <span class="ruby-value">:Bignum</span>
      <span class="ruby-constant">String</span> <span class="ruby-value">:password_hash</span>, <span class="ruby-value">null:</span> <span class="ruby-keyword">false</span>
    <span class="ruby-keyword">end</span>
    <span class="ruby-constant">Rodauth</span>.<span class="ruby-identifier">create_database_previous_password_check_functions</span>(<span class="ruby-keyword">self</span>)

    <span class="ruby-keyword">case</span> <span class="ruby-identifier">database_type</span>
    <span class="ruby-keyword">when</span> <span class="ruby-value">:postgres</span>
      <span class="ruby-identifier">user</span> = <span class="ruby-identifier">get</span>(<span class="ruby-constant">Sequel</span>.<span class="ruby-identifier">lit</span>(<span class="ruby-string">&#39;current_user&#39;</span>)).<span class="ruby-identifier">sub</span>(<span class="ruby-regexp">/_password\z/</span>, <span class="ruby-string">&#39;&#39;</span>)
      <span class="ruby-identifier">run</span> <span class="ruby-string">&quot;REVOKE ALL ON account_previous_password_hashes FROM public&quot;</span>
      <span class="ruby-identifier">run</span> <span class="ruby-string">&quot;REVOKE ALL ON FUNCTION rodauth_get_previous_salt(int8) FROM public&quot;</span>
      <span class="ruby-identifier">run</span> <span class="ruby-string">&quot;REVOKE ALL ON FUNCTION rodauth_previous_password_hash_match(int8, text) FROM public&quot;</span>
      <span class="ruby-identifier">run</span> <span class="ruby-node">&quot;GRANT INSERT, UPDATE, DELETE ON account_previous_password_hashes TO #{user}&quot;</span>
      <span class="ruby-identifier">run</span> <span class="ruby-node">&quot;GRANT SELECT(id, account_id) ON account_previous_password_hashes TO #{user}&quot;</span>
      <span class="ruby-identifier">run</span> <span class="ruby-node">&quot;GRANT USAGE ON account_previous_password_hashes_id_seq TO #{user}&quot;</span>
      <span class="ruby-identifier">run</span> <span class="ruby-node">&quot;GRANT EXECUTE ON FUNCTION rodauth_get_previous_salt(int8) TO #{user}&quot;</span>
      <span class="ruby-identifier">run</span> <span class="ruby-node">&quot;GRANT EXECUTE ON FUNCTION rodauth_previous_password_hash_match(int8, text) TO #{user}&quot;</span>
    <span class="ruby-keyword">when</span> <span class="ruby-value">:mysql</span>
      <span class="ruby-identifier">user</span> = <span class="ruby-identifier">get</span>(<span class="ruby-constant">Sequel</span>.<span class="ruby-identifier">lit</span>(<span class="ruby-string">&#39;current_user&#39;</span>)).<span class="ruby-identifier">sub</span>(<span class="ruby-regexp">/_password@/</span>, <span class="ruby-string">&#39;@&#39;</span>)
      <span class="ruby-identifier">db_name</span> = <span class="ruby-identifier">get</span>(<span class="ruby-constant">Sequel</span>.<span class="ruby-identifier">function</span>(<span class="ruby-value">:database</span>))
      <span class="ruby-identifier">run</span> <span class="ruby-node">&quot;GRANT EXECUTE ON #{db_name}.* TO #{user}&quot;</span>
      <span class="ruby-identifier">run</span> <span class="ruby-node">&quot;GRANT INSERT, UPDATE, DELETE ON account_previous_password_hashes TO #{user}&quot;</span>
      <span class="ruby-identifier">run</span> <span class="ruby-node">&quot;GRANT SELECT (id, account_id) ON account_previous_password_hashes TO #{user}&quot;</span>
    <span class="ruby-keyword">when</span> <span class="ruby-value">:mssql</span>
      <span class="ruby-identifier">user</span> = <span class="ruby-identifier">get</span>(<span class="ruby-constant">Sequel</span>.<span class="ruby-identifier">function</span>(<span class="ruby-value">:DB_NAME</span>))
      <span class="ruby-identifier">run</span> <span class="ruby-node">&quot;GRANT EXECUTE ON rodauth_get_previous_salt TO #{user}&quot;</span>
      <span class="ruby-identifier">run</span> <span class="ruby-node">&quot;GRANT EXECUTE ON rodauth_previous_password_hash_match TO #{user}&quot;</span>
      <span class="ruby-identifier">run</span> <span class="ruby-node">&quot;GRANT INSERT, UPDATE, DELETE ON account_previous_password_hashes TO #{user}&quot;</span>
      <span class="ruby-identifier">run</span> <span class="ruby-node">&quot;GRANT SELECT ON account_previous_password_hashes(id, account_id) TO #{user}&quot;</span>
    <span class="ruby-keyword">end</span>
  <span class="ruby-keyword">end</span>

  <span class="ruby-identifier">down</span> <span class="ruby-keyword">do</span>
    <span class="ruby-constant">Rodauth</span>.<span class="ruby-identifier">drop_database_previous_password_check_functions</span>(<span class="ruby-keyword">self</span>)
    <span class="ruby-constant">Rodauth</span>.<span class="ruby-identifier">drop_database_authentication_functions</span>(<span class="ruby-keyword">self</span>)
    <span class="ruby-identifier">drop_table</span>(<span class="ruby-value">:account_previous_password_hashes</span>, <span class="ruby-value">:account_password_hashes</span>)
  <span class="ruby-keyword">end</span>
<span class="ruby-keyword">end</span>
</pre>

<p>To support multiple separate migration users, you can run the migration for the password user using Sequel’s migration API:</p>

<pre class="ruby"><span class="ruby-constant">Sequel</span>.<span class="ruby-identifier">extension</span> <span class="ruby-value">:migration</span>
<span class="ruby-constant">Sequel</span>.<span class="ruby-identifier">postgres</span>(<span class="ruby-string">&#39;DATABASE_NAME&#39;</span>, <span class="ruby-value">user:</span> <span class="ruby-string">&#39;PASSWORD_USER_NAME&#39;</span>) <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">db</span><span class="ruby-operator">|</span>
  <span class="ruby-constant">Sequel</span><span class="ruby-operator">::</span><span class="ruby-constant">Migrator</span>.<span class="ruby-identifier">run</span>(<span class="ruby-identifier">db</span>, <span class="ruby-string">&#39;path/to/password_user/migrations&#39;</span>, <span class="ruby-value">table:</span> <span class="ruby-string">&#39;schema_info_password&#39;</span>)
<span class="ruby-keyword">end</span>
</pre>

<p>If the database is not PostgreSQL, MySQL, or Microsoft SQL Server, or you cannot use multiple user accounts, just combine the two migrations into a single migration, removing all the code related to database permissions and database functions.</p>

<p>One thing to notice in the above migrations is that <a href="../classes/Rodauth.html"><code>Rodauth</code></a> uses additional tables for additional features, instead of additional columns in a single table.</p>

<h3 id="label-Revoking+schema+rights+-28PostgreSQL+15-2B-29">Revoking schema rights (PostgreSQL 15+)<span><a href="#label-Revoking+schema+rights+-28PostgreSQL+15-2B-29">&para;</a> <a href="#top">&uarr;</a></span></h3>

<p>If you explicit granted access to the public schema before running the migration, revoke it afterward:</p>

<pre>psql -U postgres -c &quot;REVOKE CREATE ON SCHEMA public FROM ${DATABASE_NAME}_password&quot; ${DATABASE_NAME}</pre>

<h3 id="label-Locking+Down+-28PostgreSQL+only-29">Locking Down (PostgreSQL only)<span><a href="#label-Locking+Down+-28PostgreSQL+only-29">&para;</a> <a href="#top">&uarr;</a></span></h3>

<p>After running the migrations, you can increase security slightly by making it not possible for the <code>ph</code> account to login to the database directly. This can be accomplished by modifying the <code>pg_hba.conf</code> file.  You can also consider restricting access using GRANT/REVOKE.</p>

<p>You can restrict access to the database itself to just the <code>app</code> account.  You can run this using the <code>app</code> account, since that account owns the database:</p>

<pre>GRANT ALL ON DATABASE ${DATABASE_NAME} TO ${DATABASE_NAME};
REVOKE ALL ON DATABASE ${DATABASE_NAME} FROM public;</pre>

<p>You can also restrict access to the public schema (this is not needed if you are using a custom schema).  Note that by default, the database superuser owns the public schema, so you have to run this as the database superuser account (generally <code>postgres</code>):</p>

<pre>GRANT ALL ON SCHEMA public TO ${DATABASE_NAME};
GRANT USAGE ON SCHEMA public TO ${DATABASE_NAME}_password;
REVOKE ALL ON SCHEMA public FROM public;</pre>

<p>If you are using MySQL or Microsoft SQL Server, please consult their documentation for how to restrict access so that the <code>ph</code> account cannot login directly.</p>

<h2 id="label-Usage">Usage<span><a href="#label-Usage">&para;</a> <a href="#top">&uarr;</a></span></h2>

<h3 id="label-Basic+Usage">Basic Usage<span><a href="#label-Basic+Usage">&para;</a> <a href="#top">&uarr;</a></span></h3>

<p><a href="../classes/Rodauth.html"><code>Rodauth</code></a> is a Roda plugin and loaded the same way other Roda plugins are loaded:</p>

<pre class="ruby"><span class="ruby-identifier">plugin</span> <span class="ruby-value">:rodauth</span> <span class="ruby-keyword">do</span>
<span class="ruby-keyword">end</span>
</pre>

<p>The block passed to the plugin call uses the <a href="../classes/Rodauth.html"><code>Rodauth</code></a> configuration DSL. The one configuration method that should always be used is <code>enable</code>, which chooses which features you would like to load:</p>

<pre class="ruby"><span class="ruby-identifier">plugin</span> <span class="ruby-value">:rodauth</span> <span class="ruby-keyword">do</span>
  <span class="ruby-identifier">enable</span> <span class="ruby-value">:login</span>, <span class="ruby-value">:logout</span>
<span class="ruby-keyword">end</span>
</pre>

<p>Once features are loaded, you can use any of the configuration methods supported by the features.  There are two types of configuration methods.  The first type are called auth methods, and they take a block which overrides the default method that <a href="../classes/Rodauth.html"><code>Rodauth</code></a> uses.  Inside the block, you can call super if you want to get the default behavior, though you must provide explicit arguments to super.  There is no need to call super in before or after hooks, though. For example, if you want to add additional logging when a user logs in:</p>

<pre class="ruby"><span class="ruby-identifier">plugin</span> <span class="ruby-value">:rodauth</span> <span class="ruby-keyword">do</span>
  <span class="ruby-identifier">enable</span> <span class="ruby-value">:login</span>, <span class="ruby-value">:logout</span>
  <span class="ruby-identifier">after_login</span> <span class="ruby-keyword">do</span>
    <span class="ruby-constant">LOGGER</span>.<span class="ruby-identifier">info</span> <span class="ruby-node">&quot;#{account[:email]} logged in!&quot;</span>
  <span class="ruby-keyword">end</span>
<span class="ruby-keyword">end</span>
</pre>

<p>Inside the block, you are in the context of the <a href="../classes/Rodauth/Auth.html"><code>Rodauth::Auth</code></a> instance related to the request.  This object has access to everything related to the request via methods:</p>
<table class="rdoc-list note-list"><tbody><tr><td class='label'>request </td><td>
<p>RodaRequest instance</p>
</td></tr><tr><td class='label'>response </td><td>
<p>RodaResponse instance</p>
</td></tr><tr><td class='label'>scope </td><td>
<p>Roda instance</p>
</td></tr><tr><td class='label'>session </td><td>
<p>session hash</p>
</td></tr><tr><td class='label'>flash </td><td>
<p>flash message hash</p>
</td></tr><tr><td class='label'>account </td><td>
<p>account hash (if set by an earlier <a href="../classes/Rodauth.html"><code>Rodauth</code></a> method)</p>
</td></tr><tr><td class='label'>current_route </td><td>
<p>route name symbol (if <a href="../classes/Rodauth.html"><code>Rodauth</code></a> is handling the route)</p>
</td></tr></tbody></table>

<p>So if you want to log the IP address for the user during login:</p>

<pre class="ruby"><span class="ruby-identifier">plugin</span> <span class="ruby-value">:rodauth</span> <span class="ruby-keyword">do</span>
  <span class="ruby-identifier">enable</span> <span class="ruby-value">:login</span>, <span class="ruby-value">:logout</span>
  <span class="ruby-identifier">after_login</span> <span class="ruby-keyword">do</span>
    <span class="ruby-constant">LOGGER</span>.<span class="ruby-identifier">info</span> <span class="ruby-node">&quot;#{account[:email]} logged in from #{request.ip}&quot;</span>
  <span class="ruby-keyword">end</span>
<span class="ruby-keyword">end</span>
</pre>

<p>The second type of configuration methods are called auth value methods.  They are similar to auth methods, but instead of just accepting a block, they can optionally accept a single argument without a block, which will be treated as a block that just returns that value.  For example, the accounts_table method sets the database table storing accounts, so to override it, you can call the method with a symbol for the table:</p>

<pre class="ruby"><span class="ruby-identifier">plugin</span> <span class="ruby-value">:rodauth</span> <span class="ruby-keyword">do</span>
  <span class="ruby-identifier">enable</span> <span class="ruby-value">:login</span>, <span class="ruby-value">:logout</span>
  <span class="ruby-identifier">accounts_table</span> <span class="ruby-value">:users</span>
<span class="ruby-keyword">end</span>
</pre>

<p>Note that all auth value methods can still take a block, allowing overriding for all behavior, using any information from the request:</p>

<pre class="ruby"><span class="ruby-identifier">plugin</span> <span class="ruby-value">:rodauth</span> <span class="ruby-keyword">do</span>
  <span class="ruby-identifier">enable</span> <span class="ruby-value">:login</span>, <span class="ruby-value">:logout</span>
  <span class="ruby-identifier">accounts_table</span> <span class="ruby-keyword">do</span>
    <span class="ruby-identifier">request</span>.<span class="ruby-identifier">ip</span>.<span class="ruby-identifier">start_with?</span>(<span class="ruby-string">&quot;192.168.1.&quot;</span>) <span class="ruby-operator">?</span> <span class="ruby-value">:admins</span> <span class="ruby-operator">:</span> <span class="ruby-value">:users</span>
  <span class="ruby-keyword">end</span>
<span class="ruby-keyword">end</span>
</pre>

<p>By allowing every configuration method to take a block, <a href="../classes/Rodauth.html"><code>Rodauth</code></a> should be flexible enough to integrate into most legacy systems.</p>

<h3 id="label-Plugin+Options">Plugin Options<span><a href="#label-Plugin+Options">&para;</a> <a href="#top">&uarr;</a></span></h3>

<p>When loading the rodauth plugin, you can also pass an options hash, which configures which dependent plugins should be loaded. Options:</p>
<table class="rdoc-list note-list"><tbody><tr><td class='label'>:csrf </td><td>
<p>Set to <code>false</code> to not load a csrf plugin.  Set to <code>:rack_csrf</code> to use the csrf plugin instead of the route_csrf plugin.</p>
</td></tr><tr><td class='label'>:flash </td><td>
<p>Set to <code>false</code> to not load the flash plugin</p>
</td></tr><tr><td class='label'>:render </td><td>
<p>Set to <code>false</code> to not load the render plugin. This is useful to avoid the dependency on tilt when using alternative view libraries.</p>
</td></tr><tr><td class='label'>:json </td><td>
<p>Set to <code>true</code> to load the json and json_parser plugins. Set to <code>:only</code> to only load those plugins and not any other plugins. Note that if you are enabling features that send email, you still need to load the render plugin manually.</p>
</td></tr><tr><td class='label'>:name </td><td>
<p>Provide a name for the given <a href="../classes/Rodauth.html"><code>Rodauth</code></a> configuration, used to support multiple <a href="../classes/Rodauth.html"><code>Rodauth</code></a> configurations in a given Roda application.</p>
</td></tr><tr><td class='label'>:auth_class </td><td>
<p>Provide a specific <a href="../classes/Rodauth/Auth.html"><code>Rodauth::Auth</code></a> subclass that should be set on the Roda application. By default, an anonymous <a href="../classes/Rodauth/Auth.html"><code>Rodauth::Auth</code></a> subclass is created.</p>
</td></tr></tbody></table>

<h3 id="label-Feature+Documentation">Feature Documentation<span><a href="#label-Feature+Documentation">&para;</a> <a href="#top">&uarr;</a></span></h3>

<p>The options/methods for the supported features are listed on a separate page per feature.  If these links are not active, please view the appropriate file in the doc directory.</p>
<ul><li>
<p><a href="doc/base_rdoc.html">Base</a> (this feature is autoloaded)</p>
</li><li>
<p><a href="doc/login_password_requirements_base_rdoc.html">Login Password Requirements Base</a> (this feature is autoloaded by features that set logins/passwords)</p>
</li><li>
<p><a href="doc/email_base_rdoc.html">Email Base</a> (this feature is autoloaded by features that send email)</p>
</li><li>
<p><a href="doc/two_factor_base_rdoc.html">Two Factor Base</a> (this feature is autoloaded by 2 factor authentication features)</p>
</li><li>
<p><a href="doc/account_expiration_rdoc.html">Account Expiration</a></p>
</li><li>
<p><a href="doc/active_sessions_rdoc.html">Active Sessions</a></p>
</li><li>
<p><a href="doc/audit_logging_rdoc.html">Audit Logging</a></p>
</li><li>
<p><a href="doc/argon2_rdoc.html">Argon2</a></p>
</li><li>
<p><a href="doc/change_login_rdoc.html">Change Login</a></p>
</li><li>
<p><a href="doc/change_password_rdoc.html">Change Password</a></p>
</li><li>
<p><a href="doc/change_password_notify_rdoc.html">Change Password Notify</a></p>
</li><li>
<p><a href="doc/close_account_rdoc.html">Close Account</a></p>
</li><li>
<p><a href="doc/confirm_password_rdoc.html">Confirm Password</a></p>
</li><li>
<p><a href="doc/create_account_rdoc.html">Create Account</a></p>
</li><li>
<p><a href="doc/disallow_common_passwords_rdoc.html">Disallow Common Passwords</a></p>
</li><li>
<p><a href="doc/disallow_password_reuse_rdoc.html">Disallow Password Reuse</a></p>
</li><li>
<p><a href="doc/email_auth_rdoc.html">Email Authentication</a></p>
</li><li>
<p><a href="doc/http_basic_auth_rdoc.html">HTTP Basic Auth</a></p>
</li><li>
<p><a href="doc/internal_request_rdoc.html">Internal Request</a></p>
</li><li>
<p><a href="doc/json_rdoc.html">JSON</a></p>
</li><li>
<p><a href="doc/jwt_cors_rdoc.html">JWT CORS</a></p>
</li><li>
<p><a href="doc/jwt_refresh_rdoc.html">JWT Refresh</a></p>
</li><li>
<p><a href="doc/jwt_rdoc.html">JWT</a></p>
</li><li>
<p><a href="doc/lockout_rdoc.html">Lockout</a></p>
</li><li>
<p><a href="doc/login_rdoc.html">Login</a></p>
</li><li>
<p><a href="doc/logout_rdoc.html">Logout</a></p>
</li><li>
<p><a href="doc/otp_rdoc.html">OTP</a></p>
</li><li>
<p><a href="doc/otp_lockout_email_rdoc.html">OTP Lockout Email</a></p>
</li><li>
<p><a href="doc/otp_modify_email_rdoc.html">OTP Modify Email</a></p>
</li><li>
<p><a href="doc/otp_unlock_rdoc.html">OTP Unlock</a></p>
</li><li>
<p><a href="doc/password_complexity_rdoc.html">Password Complexity</a></p>
</li><li>
<p><a href="doc/password_expiration_rdoc.html">Password Expiration</a></p>
</li><li>
<p><a href="doc/password_grace_period_rdoc.html">Password Grace Period</a></p>
</li><li>
<p><a href="doc/password_pepper_rdoc.html">Password Pepper</a></p>
</li><li>
<p><a href="doc/path_class_methods_rdoc.html">Path Class Methods</a></p>
</li><li>
<p><a href="doc/recovery_codes_rdoc.html">Recovery Codes</a></p>
</li><li>
<p><a href="doc/remember_rdoc.html">Remember</a></p>
</li><li>
<p><a href="doc/reset_password_rdoc.html">Reset Password</a></p>
</li><li>
<p><a href="doc/reset_password_notify_rdoc.html">Reset Password Notify</a></p>
</li><li>
<p><a href="doc/session_expiration_rdoc.html">Session Expiration</a></p>
</li><li>
<p><a href="doc/single_session_rdoc.html">Single Session</a></p>
</li><li>
<p><a href="doc/sms_codes_rdoc.html">SMS Codes</a></p>
</li><li>
<p><a href="doc/update_password_hash_rdoc.html">Update Password Hash</a></p>
</li><li>
<p><a href="doc/verify_account_rdoc.html">Verify Account</a></p>
</li><li>
<p><a href="doc/verify_account_grace_period_rdoc.html">Verify Account Grace Period</a></p>
</li><li>
<p><a href="doc/verify_login_change_rdoc.html">Verify Login Change</a></p>
</li><li>
<p><a href="doc/webauthn_rdoc.html">WebAuthn</a></p>
</li><li>
<p><a href="doc/webauthn_autofill_rdoc.html">WebAuthn Autofill</a></p>
</li><li>
<p><a href="doc/webauthn_login_rdoc.html">WebAuthn Login</a></p>
</li><li>
<p><a href="doc/webauthn_modify_email_rdoc.html">WebAuthn Modify Email</a></p>
</li><li>
<p><a href="doc/webauthn_verify_account_rdoc.html">WebAuthn Verify Account</a></p>
</li></ul>

<h3 id="label-Calling+Rodauth+in+the+Routing+Tree">Calling <a href="../classes/Rodauth.html"><code>Rodauth</code></a> in the Routing Tree<span><a href="#label-Calling+Rodauth+in+the+Routing+Tree">&para;</a> <a href="#top">&uarr;</a></span></h3>

<p>In general, you will usually want to call <code>r.rodauth</code> early in your route block:</p>

<pre class="ruby"><span class="ruby-identifier">route</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">r</span><span class="ruby-operator">|</span>
  <span class="ruby-identifier">r</span>.<span class="ruby-identifier">rodauth</span>

  <span class="ruby-comment"># ...</span>
<span class="ruby-keyword">end</span>
</pre>

<p>Note that will allow <a href="../classes/Rodauth.html"><code>Rodauth</code></a> to run, but it won’t force people to login or add any security to your site.  If you want to force all users to login, you need to redirect to them login page if they are not already logged in:</p>

<pre class="ruby"><span class="ruby-identifier">route</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">r</span><span class="ruby-operator">|</span>
  <span class="ruby-identifier">r</span>.<span class="ruby-identifier">rodauth</span>
  <span class="ruby-identifier">rodauth</span>.<span class="ruby-identifier">require_authentication</span>

  <span class="ruby-comment"># ...</span>
<span class="ruby-keyword">end</span>
</pre>

<p>If only certain parts of your site require logins, then you can only redirect if they are not logged in certain branches of the routing tree:</p>

<pre class="ruby"><span class="ruby-identifier">route</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">r</span><span class="ruby-operator">|</span>
  <span class="ruby-identifier">r</span>.<span class="ruby-identifier">rodauth</span>

  <span class="ruby-identifier">r</span>.<span class="ruby-identifier">on</span> <span class="ruby-string">&quot;admin&quot;</span> <span class="ruby-keyword">do</span>
    <span class="ruby-identifier">rodauth</span>.<span class="ruby-identifier">require_authentication</span>

    <span class="ruby-comment"># ...</span>
  <span class="ruby-keyword">end</span>

  <span class="ruby-comment"># ...</span>
<span class="ruby-keyword">end</span>
</pre>

<p>In some cases you may want to have rodauth run inside a branch of the routing tree, instead of in the root.  You can do this by setting a <code>:prefix</code> when configuring <a href="../classes/Rodauth.html"><code>Rodauth</code></a>, and calling <code>r.rodauth</code> inside a matching routing tree branch:</p>

<pre class="ruby"><span class="ruby-identifier">plugin</span> <span class="ruby-value">:rodauth</span> <span class="ruby-keyword">do</span>
  <span class="ruby-identifier">enable</span> <span class="ruby-value">:login</span>, <span class="ruby-value">:logout</span>
  <span class="ruby-identifier">prefix</span> <span class="ruby-string">&quot;/auth&quot;</span>
<span class="ruby-keyword">end</span>

<span class="ruby-identifier">route</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">r</span><span class="ruby-operator">|</span>
  <span class="ruby-identifier">r</span>.<span class="ruby-identifier">on</span> <span class="ruby-string">&quot;auth&quot;</span> <span class="ruby-keyword">do</span>
    <span class="ruby-identifier">r</span>.<span class="ruby-identifier">rodauth</span>
  <span class="ruby-keyword">end</span>

  <span class="ruby-identifier">rodauth</span>.<span class="ruby-identifier">require_authentication</span>

  <span class="ruby-comment"># ...</span>
<span class="ruby-keyword">end</span>
</pre>

<h3 id="label-rodauth+Methods"><code>rodauth</code> Methods<span><a href="#label-rodauth+Methods">&para;</a> <a href="#top">&uarr;</a></span></h3>

<p>Most of Rodauth’s functionality is exposed via <code>r.rodauth</code>, which allows <a href="../classes/Rodauth.html"><code>Rodauth</code></a> to handle routes for the features you have enabled (such as <code>/login</code> for login).  However, as you have seen above, you may want to call methods on the <code>rodauth</code> object, such as for checking if the current request has been authenticated.</p>

<p>Here are methods designed to be callable on the <code>rodauth</code> object outside <code>r.rodauth</code>:</p>
<table class="rdoc-list note-list"><tbody><tr><td class='label'>require_login </td><td>
<p>Require the session be logged in, redirecting the request to the login page if the request has not been logged in.</p>
</td></tr><tr><td class='label'>require_authentication </td><td>
<p>Similar to <code>require_login</code>, but also requires two factor authentication if the account has setup two factor authentication.  Redirects the request to the two factor authentication page if logged in but not authenticated via two factors.</p>
</td></tr><tr><td class='label'>require_account </td><td>
<p>Similar to <code>require_authentication</code>, but also loads the logged in account to ensure it exists in the database.  If the account doesn’t exist, or if it exists but isn’t verified, the session is cleared and the request redirected to the login page.</p>
</td></tr><tr><td class='label'>logged_in? </td><td>
<p>Whether the session has been logged in.</p>
</td></tr><tr><td class='label'>authenticated? </td><td>
<p>Similar to <code>logged_in?</code>, but if the account has setup two factor authentication, whether the session has authenticated via two factors.</p>
</td></tr><tr><td class='label'>account! </td><td>
<p>Returns the current account record if it has already been loaded, otherwise retrieves the account from session if logged in.</p>
</td></tr><tr><td class='label'>authenticated_by </td><td>
<p>An array of strings for successful authentication methods for the current session (e.g. password/remember/webauthn).</p>
</td></tr><tr><td class='label'>possible_authentication_methods </td><td>
<p>An array of strings for possible authentication types that can be used for the account.</p>
</td></tr><tr><td class='label'>autologin_type </td><td>
<p>If the current session was authenticated via autologin, the type of autologin used.</p>
</td></tr><tr><td class='label'>require_two_factor_setup </td><td>
<p>(<a href="doc/two_factor_base_rdoc.html">two_factor_base</a> feature) Require the session to have setup two factor authentication, redirecting the request to the two factor authentication setup page if not.</p>
</td></tr><tr><td class='label'>two_factor_partially_authenticated? </td><td>
<p>(<a href="doc/two_factor_base_rdoc.html">two_factor_base</a> feature) Returns true if the session is logged in, the account has setup two factor authentication, but has not yet authenticated with a second factor.</p>
</td></tr><tr><td class='label'>uses_two_factor_authentication? </td><td>
<p>(<a href="doc/two_factor_base_rdoc.html">two_factor_base</a> feature) Whether the account for the current session has setup two factor authentication.</p>
</td></tr><tr><td class='label'>update_last_activity </td><td>
<p>(<a href="doc/account_expiration_rdoc.html">account_expiration</a> feature) Update the last activity time for the current account.  Only makes sense to use this if you are expiring accounts based on last activity.</p>
</td></tr><tr><td class='label'>require_current_password </td><td>
<p>(<a href="doc/password_expiration_rdoc.html">password_expiration</a> feature) Require a current password, redirecting the request to the change password page if the password for the account has expired.</p>
</td></tr><tr><td class='label'>require_password_authentication </td><td>
<p>(<a href="doc/confirm_password_rdoc.html">confirm_password</a> feature) If not authenticated via password and the account has a password, redirect to the password confirmation page, saving the current location to redirect back to after password has been successfully confirmed. If the <a href="doc/password_grace_period_rdoc.html">password_grace_period</a> feature is used, also redirect if the password has not been recently entered.</p>
</td></tr><tr><td class='label'>load_memory </td><td>
<p>(remember feature) If the session has not been authenticated, look for the remember cookie.  If present and valid, automatically log the session in, but mark that it was logged in via a remember key.</p>
</td></tr><tr><td class='label'>logged_in_via_remember_key? </td><td>
<p>(remember feature) Whether the current session has been logged in via a remember key.  For security sensitive actions where you want to require the user to reenter the password, you can use the <a href="doc/confirm_password_rdoc.html">confirm_password</a> feature.</p>
</td></tr><tr><td class='label'><a href="doc/http_basic_auth_rdoc.html">http_basic_auth</a> </td><td>
<p>(<a href="doc/http_basic_auth_rdoc.html">http_basic_auth</a> feature) Use HTTP Basic Authentication information to login the user if provided.</p>
</td></tr><tr><td class='label'>require_http_basic_auth </td><td>
<p>(<a href="doc/http_basic_auth_rdoc.html">http_basic_auth</a> feature) Require that HTTP Basic Authentication be provided in the request.</p>
</td></tr><tr><td class='label'>check_session_expiration </td><td>
<p>(<a href="doc/session_expiration_rdoc.html">session_expiration</a> feature) Check whether the current session has expired, automatically logging the session out if so.</p>
</td></tr><tr><td class='label'>check_active_session </td><td>
<p>(<a href="doc/active_sessions_rdoc.html">active_sessions</a> feature) Check whether the current session is still active, automatically logging the session out if not.</p>
</td></tr><tr><td class='label'>check_single_session </td><td>
<p>(<a href="doc/single_session_rdoc.html">single_session</a> feature) Check whether the current session is still the only valid session, automatically logging the session out if not.</p>
</td></tr><tr><td class='label'>verified_account? </td><td>
<p>(verify_grace_period feature) Whether the account is currently verified.  If false, it is because the account is allowed to login as they are in the grace period.</p>
</td></tr><tr><td class='label'>locked_out? </td><td>
<p>(lockout feature) Whether the account for the current session has been locked out.</p>
</td></tr><tr><td class='label'>authenticated_webauthn_id </td><td>
<p>(webauthn feature) If the current session was authenticated via webauthn, the webauthn id of the credential used.</p>
</td></tr><tr><td class='label'>*_path </td><td>
<p>One of these is added for each of the routes added by <a href="../classes/Rodauth.html"><code>Rodauth</code></a>, giving the relative path to the route. Any options passed to this method will be converted into query parameters.</p>
</td></tr><tr><td class='label'>*_url </td><td>
<p>One of these is added for each of the routes added by <a href="../classes/Rodauth.html"><code>Rodauth</code></a>, giving the URL to the route. Any options passed to this method will be converted into query parameters.</p>
</td></tr></tbody></table>

<h3 id="label-Calling+Rodauth+Methods+for+Other+Accounts">Calling <a href="../classes/Rodauth.html"><code>Rodauth</code></a> Methods for Other Accounts<span><a href="#label-Calling+Rodauth+Methods+for+Other+Accounts">&para;</a> <a href="#top">&uarr;</a></span></h3>

<p>In some cases, you may want to interact with <a href="../classes/Rodauth.html"><code>Rodauth</code></a> directly on behalf of a user.  For example, let’s say you want to create accounts or change passwords for existing accounts.  Using Rodauth’s <a href="doc/internal_request_rdoc.html">internal_request</a> feature, you can do this by:</p>

<pre class="ruby"><span class="ruby-identifier">plugin</span> <span class="ruby-value">:rodauth</span> <span class="ruby-keyword">do</span>
  <span class="ruby-identifier">enable</span> <span class="ruby-value">:create_account</span>, <span class="ruby-value">:change_password</span>, <span class="ruby-value">:internal_request</span>
<span class="ruby-keyword">end</span>
<span class="ruby-identifier">rodauth</span>.<span class="ruby-identifier">create_account</span>(<span class="ruby-value">login:</span> <span class="ruby-string">&#39;foo@example.com&#39;</span>, <span class="ruby-value">password:</span> <span class="ruby-string">&#39;...&#39;</span>)
<span class="ruby-identifier">rodauth</span>.<span class="ruby-identifier">change_password</span>(<span class="ruby-value">account_id:</span> <span class="ruby-value">24601</span>, <span class="ruby-value">password:</span> <span class="ruby-string">&#39;...&#39;</span>)
</pre>

<p>Here the <code>rodauth</code> method is called as the Roda class level, which returns the appropriate <a href="../classes/Rodauth/Auth.html"><code>Rodauth::Auth</code></a> subclass.  You call internal request methods on that class to perform actions on behalf of a user. See the <a href="doc/internal_request_rdoc.html">internal request feature documentation</a> for details.</p>

<h2 id="label-Using+Rodauth+as+a+Library">Using <a href="../classes/Rodauth.html"><code>Rodauth</code></a> as a Library<span><a href="#label-Using+Rodauth+as+a+Library">&para;</a> <a href="#top">&uarr;</a></span></h2>

<p><a href="../classes/Rodauth.html"><code>Rodauth</code></a> was designed to serve as an authentication framework for Rack applications. However, <a href="../classes/Rodauth.html"><code>Rodauth</code></a> can be used purely as a library outside of a web application. You can do this by requiring <code>rodauth</code>, and using the <a href="../classes/Rodauth.html#method-c-lib"><code>Rodauth.lib</code></a> method to return a <a href="../classes/Rodauth/Auth.html"><code>Rodauth::Auth</code></a> subclass, which you can call methods on.  You pass the <a href="../classes/Rodauth.html#method-c-lib"><code>Rodauth.lib</code></a> method an optional hash of <a href="../classes/Rodauth.html"><code>Rodauth</code></a> plugin options and a <a href="../classes/Rodauth.html"><code>Rodauth</code></a> configuration block:</p>

<pre class="ruby"><span class="ruby-identifier">require</span> <span class="ruby-string">&#39;rodauth&#39;</span>
<span class="ruby-identifier">rodauth</span> = <span class="ruby-constant">Rodauth</span>.<span class="ruby-identifier">lib</span> <span class="ruby-keyword">do</span>
  <span class="ruby-identifier">enable</span> <span class="ruby-value">:create_account</span>, <span class="ruby-value">:change_password</span>
<span class="ruby-keyword">end</span>
<span class="ruby-identifier">rodauth</span>.<span class="ruby-identifier">create_account</span>(<span class="ruby-value">login:</span> <span class="ruby-string">&#39;foo@example.com&#39;</span>, <span class="ruby-value">password:</span> <span class="ruby-string">&#39;...&#39;</span>)
<span class="ruby-identifier">rodauth</span>.<span class="ruby-identifier">change_password</span>(<span class="ruby-value">account_id:</span> <span class="ruby-value">24601</span>, <span class="ruby-value">password:</span> <span class="ruby-string">&#39;...&#39;</span>)
</pre>

<p>This supports builds on top of the <a href="doc/internal_request_rdoc.html">internal_request</a> support (it implicitly loads the <a href="doc/internal_request_rdoc.html">internal_request</a> feature before processing the configuration block), and allows the use of <a href="../classes/Rodauth.html"><code>Rodauth</code></a> in non-web applications. Note that you still have to setup a Sequel::Database connection for <a href="../classes/Rodauth.html"><code>Rodauth</code></a> to use for data storage.</p>

<h3 id="label-With+Multiple+Configurations">With Multiple Configurations<span><a href="#label-With+Multiple+Configurations">&para;</a> <a href="#top">&uarr;</a></span></h3>

<p><a href="../classes/Rodauth.html"><code>Rodauth</code></a> supports using multiple rodauth configurations in the same application.  You just need to load the plugin a second time, providing a name for any alternate configuration:</p>

<pre class="ruby"><span class="ruby-identifier">plugin</span> <span class="ruby-value">:rodauth</span> <span class="ruby-keyword">do</span>
<span class="ruby-keyword">end</span>
<span class="ruby-identifier">plugin</span> <span class="ruby-value">:rodauth</span>, <span class="ruby-value">name:</span> <span class="ruby-value">:secondary</span> <span class="ruby-keyword">do</span>
<span class="ruby-keyword">end</span>
</pre>

<p>Then in your routing code, any time you call rodauth, you can provide the name as an argument to use that configuration:</p>

<pre class="ruby"><span class="ruby-identifier">route</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">r</span><span class="ruby-operator">|</span>
  <span class="ruby-identifier">r</span>.<span class="ruby-identifier">on</span> <span class="ruby-string">&#39;secondary&#39;</span> <span class="ruby-keyword">do</span>
    <span class="ruby-identifier">r</span>.<span class="ruby-identifier">rodauth</span>(<span class="ruby-value">:secondary</span>)
  <span class="ruby-keyword">end</span>

  <span class="ruby-identifier">r</span>.<span class="ruby-identifier">rodauth</span>
<span class="ruby-keyword">end</span>
</pre>

<p>To prevent having to specify the name manually in all cases where you are using it, you can define a <code>default_rodauth_name</code> method in your Roda application that returns the name that should be used:</p>

<pre class="ruby"><span class="ruby-identifier">attr_reader</span> <span class="ruby-value">:default_rodauth_name</span>

<span class="ruby-identifier">route</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">r</span><span class="ruby-operator">|</span>
  <span class="ruby-identifier">r</span>.<span class="ruby-identifier">on</span> <span class="ruby-string">&#39;secondary&#39;</span> <span class="ruby-keyword">do</span>
    <span class="ruby-ivar">@default_rodauth_name</span> = <span class="ruby-value">:secondary</span>
    <span class="ruby-identifier">r</span>.<span class="ruby-identifier">rodauth</span> <span class="ruby-comment"># will use the :secondary configuration</span>
  <span class="ruby-keyword">end</span>

  <span class="ruby-identifier">r</span>.<span class="ruby-identifier">rodauth</span> <span class="ruby-comment"># will use the default configuration</span>
<span class="ruby-keyword">end</span>
</pre>

<p>By default, alternate configurations will use the same session keys as the primary configuration, which may be undesirable. To ensure session state is separated between configurations, you can set a session key prefix for alternate configurations.  If you are using the remember feature in both configurations, you may also want to set a different remember key in the alternate configuration:</p>

<pre class="ruby"><span class="ruby-identifier">plugin</span> <span class="ruby-value">:rodauth</span>, <span class="ruby-value">name:</span> <span class="ruby-value">:secondary</span> <span class="ruby-keyword">do</span>
  <span class="ruby-identifier">session_key_prefix</span> <span class="ruby-string">&quot;secondary_&quot;</span>
  <span class="ruby-identifier">remember_cookie_key</span> <span class="ruby-string">&quot;_secondary_remember&quot;</span>
<span class="ruby-keyword">end</span>
</pre>

<h3 id="label-With+Password+Hashes+Inside+the+Accounts+Table">With Password Hashes Inside the Accounts Table<span><a href="#label-With+Password+Hashes+Inside+the+Accounts+Table">&para;</a> <a href="#top">&uarr;</a></span></h3>

<p>You can use <a href="../classes/Rodauth.html"><code>Rodauth</code></a> if you are storing password hashes in the same table as the accounts.  You just need to specify which column stores the password hash:</p>

<pre class="ruby"><span class="ruby-identifier">plugin</span> <span class="ruby-value">:rodauth</span> <span class="ruby-keyword">do</span>
  <span class="ruby-identifier">account_password_hash_column</span> <span class="ruby-value">:password_hash</span>
<span class="ruby-keyword">end</span>
</pre>

<p>When this option is set, <a href="../classes/Rodauth.html"><code>Rodauth</code></a> will do the password hash check in ruby.</p>

<h3 id="label-When+Using+PostgreSQL-2FMySQL-2FMicrosoft+SQL+Server+without+Database+Functions">When Using PostgreSQL/MySQL/Microsoft SQL Server without Database Functions<span><a href="#label-When+Using+PostgreSQL-2FMySQL-2FMicrosoft+SQL+Server+without+Database+Functions">&para;</a> <a href="#top">&uarr;</a></span></h3>

<p>If you want to use <a href="../classes/Rodauth.html"><code>Rodauth</code></a> on PostgreSQL, MySQL, or Microsoft SQL Server without using database functions for authentication, but still storing password hashes in a separate table, you can do so:</p>

<pre class="ruby"><span class="ruby-identifier">plugin</span> <span class="ruby-value">:rodauth</span> <span class="ruby-keyword">do</span>
  <span class="ruby-identifier">use_database_authentication_functions?</span> <span class="ruby-keyword">false</span>
<span class="ruby-keyword">end</span>
</pre>

<p>Conversely, if you implement the rodauth_get_salt and rodauth_valid_password_hash functions on a database that isn’t PostgreSQL, MySQL, or Microsoft SQL Server, you can set this value to true.</p>

<h3 id="label-With+Custom+Authentication">With Custom Authentication<span><a href="#label-With+Custom+Authentication">&para;</a> <a href="#top">&uarr;</a></span></h3>

<p>You can use <a href="../classes/Rodauth.html"><code>Rodauth</code></a> with other authentication types, by using some of Rodauth’s configuration methods.</p>

<p>Note that when using custom authentication, using some of Rodauth’s features such as change login and change password either would not make sense or would require some additional custom configuration. The login and logout features should work correctly with the examples below, though.</p>

<h4 id="label-Using+LDAP+Authentication">Using LDAP Authentication<span><a href="#label-Using+LDAP+Authentication">&para;</a> <a href="#top">&uarr;</a></span></h4>

<p>If you have accounts stored in the database, but authentication happens via LDAP, you can use the <code>simple_ldap_authenticator</code> library:</p>

<pre class="ruby"><span class="ruby-identifier">require</span> <span class="ruby-string">&#39;simple_ldap_authenticator&#39;</span>
<span class="ruby-identifier">plugin</span> <span class="ruby-value">:rodauth</span> <span class="ruby-keyword">do</span>
  <span class="ruby-identifier">enable</span> <span class="ruby-value">:login</span>, <span class="ruby-value">:logout</span>
  <span class="ruby-identifier">require_bcrypt?</span> <span class="ruby-keyword">false</span>
  <span class="ruby-identifier">password_match?</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">password</span><span class="ruby-operator">|</span>
    <span class="ruby-constant">SimpleLdapAuthenticator</span>.<span class="ruby-identifier">valid?</span>(<span class="ruby-identifier">account</span>[<span class="ruby-value">:email</span>], <span class="ruby-identifier">password</span>)
  <span class="ruby-keyword">end</span>
<span class="ruby-keyword">end</span>
</pre>

<p>If you aren’t storing accounts in the database, but want to allow any valid LDAP user to login, you can do something like this:</p>

<pre class="ruby"><span class="ruby-identifier">require</span> <span class="ruby-string">&#39;simple_ldap_authenticator&#39;</span>
<span class="ruby-identifier">plugin</span> <span class="ruby-value">:rodauth</span> <span class="ruby-keyword">do</span>
  <span class="ruby-identifier">enable</span> <span class="ruby-value">:login</span>, <span class="ruby-value">:logout</span>

  <span class="ruby-comment"># Don&#39;t require the bcrypt library, since using LDAP for auth</span>
  <span class="ruby-identifier">require_bcrypt?</span> <span class="ruby-keyword">false</span>

  <span class="ruby-comment"># Store session value in :login key, since the :account_id</span>
  <span class="ruby-comment"># default wouldn&#39;t make sense</span>
  <span class="ruby-identifier">session_key</span> <span class="ruby-value">:login</span>

  <span class="ruby-comment"># Use the login provided as the session value</span>
  <span class="ruby-identifier">account_session_value</span>{<span class="ruby-identifier">account</span>}

  <span class="ruby-comment"># Treat the login itself as the account</span>
  <span class="ruby-identifier">account_from_login</span>{<span class="ruby-operator">|</span><span class="ruby-identifier">l</span><span class="ruby-operator">|</span> <span class="ruby-identifier">l</span>.<span class="ruby-identifier">to_s</span>}

  <span class="ruby-identifier">password_match?</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">password</span><span class="ruby-operator">|</span>
    <span class="ruby-constant">SimpleLdapAuthenticator</span>.<span class="ruby-identifier">valid?</span>(<span class="ruby-identifier">account</span>, <span class="ruby-identifier">password</span>)
  <span class="ruby-keyword">end</span>
<span class="ruby-keyword">end</span>
</pre>

<h4 id="label-Using+Facebook+Authentication">Using Facebook Authentication<span><a href="#label-Using+Facebook+Authentication">&para;</a> <a href="#top">&uarr;</a></span></h4>

<p>Here’s an example of authentication using Facebook with a JSON API. This setup assumes you have client-side code to submit JSON POST requests to <code>/login</code> with an <code>access_token</code> parameter that is set to the user’s Facebook OAuth access token.</p>

<pre class="ruby"><span class="ruby-identifier">require</span> <span class="ruby-string">&#39;koala&#39;</span>
<span class="ruby-identifier">plugin</span> <span class="ruby-value">:rodauth</span> <span class="ruby-keyword">do</span>
  <span class="ruby-identifier">enable</span> <span class="ruby-value">:login</span>, <span class="ruby-value">:logout</span>, <span class="ruby-value">:jwt</span>

  <span class="ruby-identifier">require_bcrypt?</span> <span class="ruby-keyword">false</span>
  <span class="ruby-identifier">session_key</span> <span class="ruby-value">:facebook_email</span>
  <span class="ruby-identifier">account_session_value</span>{<span class="ruby-identifier">account</span>}

  <span class="ruby-identifier">login_param</span> <span class="ruby-string">&#39;access_token&#39;</span>

  <span class="ruby-identifier">account_from_login</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">access_token</span><span class="ruby-operator">|</span>
    <span class="ruby-identifier">fb</span> = <span class="ruby-constant">Koala</span><span class="ruby-operator">::</span><span class="ruby-constant">Facebook</span><span class="ruby-operator">::</span><span class="ruby-constant">API</span>.<span class="ruby-identifier">new</span>(<span class="ruby-identifier">access_token</span>)
    <span class="ruby-keyword">if</span> <span class="ruby-identifier">me</span> = <span class="ruby-identifier">fb</span>.<span class="ruby-identifier">get_object</span>(<span class="ruby-string">&#39;me&#39;</span>, <span class="ruby-value">fields:</span> [<span class="ruby-value">:email</span>])
      <span class="ruby-identifier">me</span>[<span class="ruby-string">&#39;email&#39;</span>]
    <span class="ruby-keyword">end</span>
  <span class="ruby-keyword">end</span>

  <span class="ruby-comment"># there is no password!</span>
  <span class="ruby-identifier">password_match?</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">pass</span><span class="ruby-operator">|</span>
    <span class="ruby-keyword">true</span>
  <span class="ruby-keyword">end</span>
<span class="ruby-keyword">end</span>
</pre>

<h3 id="label-With+Rails">With Rails<span><a href="#label-With+Rails">&para;</a> <a href="#top">&uarr;</a></span></h3>

<p>If you’re using Rails, you can use the <a target="_top" href="https://github.com/janko/rodauth-rails">rodauth-rails</a> gem which provides Rails integration for <a href="../classes/Rodauth.html"><code>Rodauth</code></a>. Some of its features include:</p>
<ul><li>
<p>generators for <a href="../classes/Rodauth.html"><code>Rodauth</code></a> &amp; Sequel configuration, as well as views and mailers</p>
</li><li>
<p>uses Rails’ flash messages and CSRF protection</p>
</li><li>
<p>automatically sets HMAC secret to Rails’ secret key base</p>
</li><li>
<p>uses Action Controller &amp; Action View for rendering templates</p>
</li><li>
<p>uses Action Mailer for sending emails</p>
</li></ul>

<p>Follow the instructions in the rodauth-rails <a href="README_rdoc.html">README</a> to get started.</p>

<h3 id="label-With+Other+Web+Frameworks">With Other Web Frameworks<span><a href="#label-With+Other+Web+Frameworks">&para;</a> <a href="#top">&uarr;</a></span></h3>

<p>You can use <a href="../classes/Rodauth.html"><code>Rodauth</code></a> even if your application does not use the Roda web framework.  This is possible by adding a Roda middleware that uses Rodauth:</p>

<pre class="ruby"><span class="ruby-identifier">require</span> <span class="ruby-string">&#39;roda&#39;</span>

<span class="ruby-keyword">class</span> <span class="ruby-constant">RodauthApp</span> <span class="ruby-operator">&lt;</span> <span class="ruby-constant">Roda</span>
  <span class="ruby-identifier">plugin</span> <span class="ruby-value">:middleware</span>
  <span class="ruby-identifier">plugin</span> <span class="ruby-value">:rodauth</span> <span class="ruby-keyword">do</span>
    <span class="ruby-identifier">enable</span> <span class="ruby-value">:login</span>
  <span class="ruby-keyword">end</span>

  <span class="ruby-identifier">route</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">r</span><span class="ruby-operator">|</span>
    <span class="ruby-identifier">r</span>.<span class="ruby-identifier">rodauth</span>
    <span class="ruby-identifier">rodauth</span>.<span class="ruby-identifier">require_authentication</span>
    <span class="ruby-identifier">env</span>[<span class="ruby-string">&#39;rodauth&#39;</span>] = <span class="ruby-identifier">rodauth</span>
  <span class="ruby-keyword">end</span>
<span class="ruby-keyword">end</span>

<span class="ruby-identifier">use</span> <span class="ruby-constant">RodauthApp</span>
</pre>

<p>Note that <a href="../classes/Rodauth.html"><code>Rodauth</code></a> expects the Roda app it is used in to provide a layout.  So if you are using <a href="../classes/Rodauth.html"><code>Rodauth</code></a> as middleware for another app, if you don’t have a <code>views/layout.erb</code> file that <a href="../classes/Rodauth.html"><code>Rodauth</code></a> can use, you should probably also add load Roda’s <code>render</code> plugin with the appropriate settings that allow <a href="../classes/Rodauth.html"><code>Rodauth</code></a> to use the same layout as the application.</p>

<p>By setting <code>env[&#39;rodauth&#39;] = rodauth</code> in the route block inside the middleware, you can easily provide a way for your application to call <a href="../classes/Rodauth.html"><code>Rodauth</code></a> methods.</p>

<p>If you’re using the remember feature with <code>extend_remember_deadline?</code> set to true, you’ll want to load roda’s middleware plugin with <code>forward_response_headers: true</code> option, so that <code>Set-Cookie</code> header changes from the <code>load_memory</code> call in the route block are propagated when the request is forwarded to the main app.</p>

<p>Here are some examples of integrating <a href="../classes/Rodauth.html"><code>Rodauth</code></a> into applications that don’t use Roda:</p>
<ul><li>
<p><a target="_top" href="https://github.com/jeremyevans/ginatra/commit/28108ebec96e8d42596ee55b01c3f7b50c155dd1">Ginatra, a Sinatra-based git repository viewer</a></p>
</li><li>
<p><a target="_top" href="https://github.com/janko/rodauth-demo-rails">Rodauth’s demo site as a Rails 6 application</a></p>
</li><li>
<p><a target="_top" href="https://github.com/davydovanton/grape-rodauth">Grape application</a></p>
</li><li>
<p><a target="_top" href="https://github.com/davydovanton/rodauth_hanami">Hanami application</a></p>
</li></ul>

<h3 id="label-Using+2+Factor+Authentication">Using 2 Factor Authentication<span><a href="#label-Using+2+Factor+Authentication">&para;</a> <a href="#top">&uarr;</a></span></h3>

<p><a href="../classes/Rodauth.html"><code>Rodauth</code></a> ships with 2 factor authentication support via the following methods:</p>
<ul><li>
<p>WebAuthn</p>
</li><li>
<p>TOTP (Time-Based One-Time Passwords, RFC 6238).</p>
</li><li>
<p>SMS Codes</p>
</li><li>
<p>Recovery Codes</p>
</li></ul>

<p>There are multiple ways to integrate 2 factor authentication with <a href="../classes/Rodauth.html"><code>Rodauth</code></a>, based on the needs of the application.  By default, SMS codes and recovery codes are treated only as backup 2nd factors, a user cannot enable them without first enabling another 2nd factor authentication method.  However, you can change this by using a configuration method.</p>

<p>If you want to support but not require 2 factor authentication:</p>

<pre class="ruby"><span class="ruby-identifier">plugin</span> <span class="ruby-value">:rodauth</span> <span class="ruby-keyword">do</span>
  <span class="ruby-identifier">enable</span> <span class="ruby-value">:login</span>, <span class="ruby-value">:logout</span>, <span class="ruby-value">:otp</span>, <span class="ruby-value">:recovery_codes</span>, <span class="ruby-value">:sms_codes</span>
<span class="ruby-keyword">end</span>
<span class="ruby-identifier">route</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">r</span><span class="ruby-operator">|</span>
  <span class="ruby-identifier">r</span>.<span class="ruby-identifier">rodauth</span>
  <span class="ruby-identifier">rodauth</span>.<span class="ruby-identifier">require_authentication</span>

  <span class="ruby-comment"># ...</span>
<span class="ruby-keyword">end</span>
</pre>

<p>If you want to force all users to use 2 factor authentication, requiring users that don’t currently have two authentication to set it up:</p>

<pre class="ruby"><span class="ruby-identifier">route</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">r</span><span class="ruby-operator">|</span>
  <span class="ruby-identifier">r</span>.<span class="ruby-identifier">rodauth</span>
  <span class="ruby-identifier">rodauth</span>.<span class="ruby-identifier">require_authentication</span>
  <span class="ruby-identifier">rodauth</span>.<span class="ruby-identifier">require_two_factor_setup</span>

  <span class="ruby-comment"># ...</span>
<span class="ruby-keyword">end</span>
</pre>

<p>Similarly to requiring authentication in general, it’s possible to require login authentication for most of the site, but require 2 factor authentication only for particular branches:</p>

<pre class="ruby"><span class="ruby-identifier">route</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">r</span><span class="ruby-operator">|</span>
  <span class="ruby-identifier">r</span>.<span class="ruby-identifier">rodauth</span>
  <span class="ruby-identifier">rodauth</span>.<span class="ruby-identifier">require_login</span>

  <span class="ruby-identifier">r</span>.<span class="ruby-identifier">on</span> <span class="ruby-string">&quot;admin&quot;</span> <span class="ruby-keyword">do</span>
    <span class="ruby-identifier">rodauth</span>.<span class="ruby-identifier">require_two_factor_authenticated</span>
  <span class="ruby-keyword">end</span>

  <span class="ruby-comment"># ...</span>
<span class="ruby-keyword">end</span>
</pre>

<h3 id="label-JSON+API+Support">JSON API Support<span><a href="#label-JSON+API+Support">&para;</a> <a href="#top">&uarr;</a></span></h3>

<p>To add support for handling JSON responses, you can pass the <code>:json</code> option to the plugin, and enable the JWT feature in addition to other features you plan to use:</p>

<pre class="ruby"><span class="ruby-identifier">plugin</span> <span class="ruby-value">:rodauth</span>, <span class="ruby-value">json:</span> <span class="ruby-keyword">true</span> <span class="ruby-keyword">do</span>
  <span class="ruby-identifier">enable</span> <span class="ruby-value">:login</span>, <span class="ruby-value">:logout</span>, <span class="ruby-value">:jwt</span>
<span class="ruby-keyword">end</span>
</pre>

<p>If you do not want to load the HTML plugins that <a href="../classes/Rodauth.html"><code>Rodauth</code></a> usually loads (render, csrf, flash, h), because you are building a JSON-only API, pass <code>:json =&gt; :only</code></p>

<pre class="ruby"><span class="ruby-identifier">plugin</span> <span class="ruby-value">:rodauth</span>, <span class="ruby-value">json:</span> <span class="ruby-value">:only</span> <span class="ruby-keyword">do</span>
  <span class="ruby-identifier">enable</span> <span class="ruby-value">:login</span>, <span class="ruby-value">:logout</span>, <span class="ruby-value">:jwt</span>
<span class="ruby-keyword">end</span>
</pre>

<p>Note that by default, the features that send email depend on the render plugin, so if using the <code>json: :only</code> option, you either need to load the render plugin manually or you need to use the necessary *_email_body configuration options to specify the body of the emails.</p>

<p>The JWT feature enables JSON API support for all of the other features that <a href="../classes/Rodauth.html"><code>Rodauth</code></a> ships with. If you would like JSON API access that still uses rack session for storing session data, enable the JSON feature instead:</p>

<pre class="ruby"><span class="ruby-identifier">plugin</span> <span class="ruby-value">:rodauth</span>, <span class="ruby-value">json:</span> <span class="ruby-keyword">true</span> <span class="ruby-keyword">do</span>
  <span class="ruby-identifier">enable</span> <span class="ruby-value">:login</span>, <span class="ruby-value">:logout</span>, <span class="ruby-value">:json</span>
  <span class="ruby-identifier">only_json?</span> <span class="ruby-keyword">true</span> <span class="ruby-comment"># if you want to only handle JSON requests</span>
<span class="ruby-keyword">end</span>
</pre>

<h3 id="label-Adding+Custom+Methods+to+the+rodauth+Object">Adding Custom Methods to the <code>rodauth</code> Object<span><a href="#label-Adding+Custom+Methods+to+the+rodauth+Object">&para;</a> <a href="#top">&uarr;</a></span></h3>

<p>Inside the configuration block, you can use <code>auth_class_eval</code> to add custom methods that will be callable on the <code>rodauth</code> object.</p>

<pre class="ruby"><span class="ruby-identifier">plugin</span> <span class="ruby-value">:rodauth</span> <span class="ruby-keyword">do</span>
  <span class="ruby-identifier">enable</span> <span class="ruby-value">:login</span>

  <span class="ruby-identifier">auth_class_eval</span> <span class="ruby-keyword">do</span>
    <span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">require_admin</span>
      <span class="ruby-identifier">request</span>.<span class="ruby-identifier">redirect</span>(<span class="ruby-string">&quot;/&quot;</span>) <span class="ruby-keyword">unless</span> <span class="ruby-identifier">account</span>[<span class="ruby-value">:admin</span>]
    <span class="ruby-keyword">end</span>
  <span class="ruby-keyword">end</span>
<span class="ruby-keyword">end</span>

<span class="ruby-identifier">route</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">r</span><span class="ruby-operator">|</span>
  <span class="ruby-identifier">r</span>.<span class="ruby-identifier">rodauth</span>

  <span class="ruby-identifier">r</span>.<span class="ruby-identifier">on</span> <span class="ruby-string">&quot;admin&quot;</span> <span class="ruby-keyword">do</span>
    <span class="ruby-identifier">rodauth</span>.<span class="ruby-identifier">require_admin</span>
  <span class="ruby-keyword">end</span>
<span class="ruby-keyword">end</span>
</pre>

<h3 id="label-Using+External+Features">Using External Features<span><a href="#label-Using+External+Features">&para;</a> <a href="#top">&uarr;</a></span></h3>

<p>The <code>enable</code> configuration method is able to load features external to <a href="../classes/Rodauth.html"><code>Rodauth</code></a>.  You need to place the external feature file where it can be required via rodauth/features/feature_name. That file should use the following basic structure</p>

<pre class="ruby"><span class="ruby-keyword">module</span> <span class="ruby-constant">Rodauth</span>
  <span class="ruby-comment"># :feature_name will be the argument given to enable to</span>
  <span class="ruby-comment"># load the feature, :FeatureName is optional and will be used to</span>
  <span class="ruby-comment"># set a constant name for prettier inspect output.</span>
  <span class="ruby-constant">Feature</span>.<span class="ruby-identifier">define</span>(<span class="ruby-value">:feature_name</span>, <span class="ruby-value">:FeatureName</span>) <span class="ruby-keyword">do</span>
    <span class="ruby-comment"># Shortcut for defining auth value methods with static values</span>
    <span class="ruby-identifier">auth_value_method</span> <span class="ruby-value">:method_name</span>, <span class="ruby-value">1</span> <span class="ruby-comment"># method_value</span>

    <span class="ruby-identifier">auth_value_methods</span> <span class="ruby-comment"># one argument per auth value method</span>

    <span class="ruby-identifier">auth_methods</span> <span class="ruby-comment"># one argument per auth method</span>

    <span class="ruby-identifier">route</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">r</span><span class="ruby-operator">|</span>
      <span class="ruby-comment"># This block is taken for requests to the feature&#39;s route.</span>
      <span class="ruby-comment"># This block is evaluated in the scope of the Rodauth::Auth instance.</span>
      <span class="ruby-comment"># r is the Roda::RodaRequest instance for the request</span>

      <span class="ruby-identifier">r</span>.<span class="ruby-identifier">get</span> <span class="ruby-keyword">do</span>
      <span class="ruby-keyword">end</span>

      <span class="ruby-identifier">r</span>.<span class="ruby-identifier">post</span> <span class="ruby-keyword">do</span>
      <span class="ruby-keyword">end</span>
    <span class="ruby-keyword">end</span>

    <span class="ruby-identifier">configuration_module_eval</span> <span class="ruby-keyword">do</span>
      <span class="ruby-comment"># define additional configuration specific methods here, if any</span>
    <span class="ruby-keyword">end</span>

    <span class="ruby-comment"># define the default behavior for the auth_methods</span>
    <span class="ruby-comment"># and auth_value_methods</span>
    <span class="ruby-comment"># ...</span>
  <span class="ruby-keyword">end</span>
<span class="ruby-keyword">end</span>
</pre>

<p>See the <a href="doc/guides/internals_rdoc.html">internals guide</a> for a more complete example of how to construct features.</p>

<h3 id="label-Overriding+Route-Level+Behavior">Overriding Route-Level Behavior<span><a href="#label-Overriding+Route-Level+Behavior">&para;</a> <a href="#top">&uarr;</a></span></h3>

<p>All of Rodauth’s configuration methods change the behavior of the <a href="../classes/Rodauth/Auth.html"><code>Rodauth::Auth</code></a> instance.  However, in some cases you may want to overriding handling at the routing layer.  You can do this easily by adding an appropriate route before calling <code>r.rodauth</code>:</p>

<pre class="ruby"><span class="ruby-identifier">route</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">r</span><span class="ruby-operator">|</span>
  <span class="ruby-identifier">r</span>.<span class="ruby-identifier">post</span> <span class="ruby-string">&#39;login&#39;</span> <span class="ruby-keyword">do</span>
    <span class="ruby-comment"># Custom POST /login handling here</span>
  <span class="ruby-keyword">end</span>

  <span class="ruby-identifier">r</span>.<span class="ruby-identifier">rodauth</span>
<span class="ruby-keyword">end</span>
</pre>

<h3 id="label-Precompiling+Rodauth+Templates">Precompiling <a href="../classes/Rodauth.html"><code>Rodauth</code></a> Templates<span><a href="#label-Precompiling+Rodauth+Templates">&para;</a> <a href="#top">&uarr;</a></span></h3>

<p><a href="../classes/Rodauth.html"><code>Rodauth</code></a> serves templates from it’s gem folder.  If you are using a forking webserver and want to preload the compiled templates to save memory, or if you are chrooting your application, you can benefit from precompiling your rodauth templates:</p>

<pre class="ruby"><span class="ruby-identifier">plugin</span> <span class="ruby-value">:rodauth</span> <span class="ruby-keyword">do</span>
  <span class="ruby-comment"># ...</span>
<span class="ruby-keyword">end</span>
<span class="ruby-identifier">precompile_rodauth_templates</span>
</pre>

<h2 id="label-Ruby+Support+Policy">Ruby Support Policy<span><a href="#label-Ruby+Support+Policy">&para;</a> <a href="#top">&uarr;</a></span></h2>

<p><a href="../classes/Rodauth.html"><code>Rodauth</code></a> fully supports the currently supported versions of Ruby (MRI) and JRuby.  It may support unsupported versions of Ruby or JRuby, but such support may be dropped in any minor version if keeping it becomes a support issue.  The minimum Ruby version required to run the current version of <a href="../classes/Rodauth.html"><code>Rodauth</code></a> is 1.9.2.</p>

<h2 id="label-Similar+Projects">Similar Projects<span><a href="#label-Similar+Projects">&para;</a> <a href="#top">&uarr;</a></span></h2>

<p>All of these are Rails-specific:</p>
<ul><li>
<p><a target="_top" href="https://github.com/heartcombo/devise">Devise</a></p>
</li><li>
<p><a target="_top" href="https://github.com/binarylogic/authlogic">Authlogic</a></p>
</li><li>
<p><a target="_top" href="https://github.com/Sorcery/sorcery">Sorcery</a></p>
</li></ul>

<h2 id="label-Author">Author<span><a href="#label-Author">&para;</a> <a href="#top">&uarr;</a></span></h2>

<p>Jeremy Evans &lt;code@jeremyevans.net&gt;</p>
</div>
<div id='context'>
</div>

</div>
</div>

<div id='footer-push'></div>
</div>
<div id='footer'>
<a href="https://github.com/jeremyevans/hanna"><strong>Hanna</strong> RDoc template</a>
</div>
</body>
</html>
